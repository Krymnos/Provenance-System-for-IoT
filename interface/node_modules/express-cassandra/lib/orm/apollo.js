'use strict';

var Promise = require('bluebird');
var util = require('util');
var _ = require('lodash');

var elasticsearch = void 0;
try {
  // eslint-disable-next-line import/no-extraneous-dependencies, import/no-unresolved
  elasticsearch = require('elasticsearch');
} catch (e) {
  elasticsearch = null;
}

var gremlin = void 0;
try {
  // eslint-disable-next-line import/no-extraneous-dependencies, import/no-unresolved
  gremlin = require('gremlin');
} catch (e) {
  gremlin = null;
}

var dseDriver = void 0;
try {
  // eslint-disable-next-line import/no-extraneous-dependencies, import/no-unresolved
  dseDriver = require('dse-driver');
} catch (e) {
  dseDriver = null;
}

var cql = Promise.promisifyAll(dseDriver || require('cassandra-driver'));

var BaseModel = require('./base_model');
var schemer = require('../validators/schema');
var normalizer = require('../utils/normalizer');
var buildError = require('./apollo_error.js');

var KeyspaceBuilder = require('../builders/keyspace');
var UdtBuilder = require('../builders/udt');
var UdfBuilder = require('../builders/udf');
var UdaBuilder = require('../builders/uda');
var ElassandraBuilder = require('../builders/elassandra');
var JanusGraphBuilder = require('../builders/janusgraph');

var DEFAULT_REPLICATION_FACTOR = 1;

var noop = function noop() {};

var Apollo = function f(connection, options) {
  if (!connection) {
    throw buildError('model.validator.invalidconfig', 'Cassandra connection configuration undefined');
  }

  options = options || {};

  if (!options.defaultReplicationStrategy) {
    options.defaultReplicationStrategy = {
      class: 'SimpleStrategy',
      replication_factor: DEFAULT_REPLICATION_FACTOR
    };
  }

  this._options = options;
  this._models = {};
  this._keyspace = connection.keyspace;
  this._connection = connection;
  this._client = null;
  this._esclient = null;
  this._gremlin_client = null;
};

Apollo.prototype = {

  _generate_model(properties) {
    var Model = function f() {
      for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      BaseModel.apply(this, Array.prototype.slice.call(args));
    };

    util.inherits(Model, BaseModel);

    Object.keys(BaseModel).forEach(function (key) {
      Model[key] = BaseModel[key];
    });

    Model._set_properties(properties);

    return Model;
  },

  create_es_client() {
    if (!elasticsearch) {
      throw new Error('Configured to use elassandra, but elasticsearch module was not found, try npm install elasticsearch');
    }

    var contactPoints = this._connection.contactPoints;
    var defaultHosts = [];
    contactPoints.forEach(function (host) {
      defaultHosts.push({ host });
    });

    var esClientConfig = _.defaults(this._connection.elasticsearch, {
      hosts: defaultHosts,
      sniffOnStart: true
    });
    this._esclient = new elasticsearch.Client(esClientConfig);
    return this._esclient;
  },

  _assert_es_index(callback) {
    var esClient = this.create_es_client();
    var indexName = this._keyspace;

    var elassandraBuilder = new ElassandraBuilder(esClient);
    elassandraBuilder.assert_index(indexName, callback);
  },

  create_gremlin_client() {
    if (!gremlin) {
      throw new Error('Configured to use janus graph server, but gremlin module was not found, try npm install gremlin');
    }

    var contactPoints = this._connection.contactPoints;
    var defaultHosts = [];
    contactPoints.forEach(function (host) {
      defaultHosts.push({ host });
    });

    var gremlinConfig = _.defaults(this._connection.gremlin, {
      host: defaultHosts[0],
      port: 8182,
      options: {}
    });
    this._gremlin_client = gremlin.createClient(gremlinConfig.port, gremlinConfig.host, gremlinConfig.options);
    return this._gremlin_client;
  },

  _assert_gremlin_graph(callback) {
    var gremlinClient = this.create_gremlin_client();
    var keyspaceName = this._keyspace;
    var graphName = `${keyspaceName}_graph`;

    var graphBuilder = new JanusGraphBuilder(gremlinClient);
    graphBuilder.assert_graph(graphName, callback);
  },

  get_system_client() {
    var connection = _.cloneDeep(this._connection);
    delete connection.keyspace;

    return new cql.Client(connection);
  },

  get_keyspace_name() {
    return this._keyspace;
  },

  _assert_keyspace(callback) {
    var client = this.get_system_client();
    var keyspaceName = this._keyspace;
    var options = this._options;

    var keyspaceBuilder = new KeyspaceBuilder(client);

    keyspaceBuilder.get_keyspace(keyspaceName, function (err, keyspaceObject) {
      if (err) {
        callback(err);
        return;
      }

      if (!keyspaceObject) {
        keyspaceBuilder.create_keyspace(keyspaceName, options.defaultReplicationStrategy, callback);
        return;
      }

      var dbReplication = normalizer.normalize_replication_option(keyspaceObject.replication);
      var ormReplication = normalizer.normalize_replication_option(options.defaultReplicationStrategy);

      if (!_.isEqual(dbReplication, ormReplication)) {
        keyspaceBuilder.alter_keyspace(keyspaceName, options.defaultReplicationStrategy, callback);
        return;
      }

      client.shutdown(function () {
        callback();
      });
    });
  },

  _assert_user_defined_types(callback) {
    var client = this._define_connection;
    var options = this._options;
    var keyspace = this._keyspace;

    if (!options.udts) {
      callback();
      return;
    }

    var udtBuilder = new UdtBuilder(client);

    Promise.mapSeries(Object.keys(options.udts), function (udtKey) {
      return new Promise(function (resolve, reject) {
        var udtCallback = function udtCallback(err) {
          if (err) {
            reject(err);
            return;
          }
          resolve();
        };
        udtBuilder.get_udt(udtKey, keyspace, function (err, udtObject) {
          if (err) {
            udtCallback(err);
            return;
          }

          if (!udtObject) {
            udtBuilder.create_udt(udtKey, options.udts[udtKey], udtCallback);
            return;
          }

          var udtKeys = Object.keys(options.udts[udtKey]);
          var udtValues = _.map(_.values(options.udts[udtKey]), normalizer.normalize_user_defined_type);
          var fieldNames = udtObject.field_names;
          var fieldTypes = _.map(udtObject.field_types, normalizer.normalize_user_defined_type);

          if (_.difference(udtKeys, fieldNames).length === 0 && _.difference(udtValues, fieldTypes).length === 0) {
            udtCallback();
            return;
          }

          throw new Error(util.format('User defined type "%s" already exists but does not match the udt definition. ' + 'Consider altering or droping the type.', udtKey));
        });
      });
    }).then(function () {
      callback();
    }).catch(function (err) {
      callback(err);
    });
  },

  _assert_user_defined_functions(callback) {
    var client = this._define_connection;
    var options = this._options;
    var keyspace = this._keyspace;

    if (!options.udfs) {
      callback();
      return;
    }

    var udfBuilder = new UdfBuilder(client);

    Promise.mapSeries(Object.keys(options.udfs), function (udfKey) {
      return new Promise(function (resolve, reject) {
        var udfCallback = function udfCallback(err) {
          if (err) {
            reject(err);
            return;
          }
          resolve();
        };

        udfBuilder.validate_definition(udfKey, options.udfs[udfKey]);

        udfBuilder.get_udf(udfKey, keyspace, function (err, udfObject) {
          if (err) {
            udfCallback(err);
            return;
          }

          if (!udfObject) {
            udfBuilder.create_udf(udfKey, options.udfs[udfKey], udfCallback);
            return;
          }

          var udfLanguage = options.udfs[udfKey].language;
          var resultLanguage = udfObject.language;

          var udfCode = options.udfs[udfKey].code;
          var resultCode = udfObject.body;

          var udfReturnType = normalizer.normalize_user_defined_type(options.udfs[udfKey].returnType);
          var resultReturnType = normalizer.normalize_user_defined_type(udfObject.return_type);

          var udfInputs = options.udfs[udfKey].inputs ? options.udfs[udfKey].inputs : {};
          var udfInputKeys = Object.keys(udfInputs);
          var udfInputValues = _.map(_.values(udfInputs), normalizer.normalize_user_defined_type);
          var resultArgumentNames = udfObject.argument_names;
          var resultArgumentTypes = _.map(udfObject.argument_types, normalizer.normalize_user_defined_type);

          if (udfLanguage === resultLanguage && udfCode === resultCode && udfReturnType === resultReturnType && _.isEqual(udfInputKeys, resultArgumentNames) && _.isEqual(udfInputValues, resultArgumentTypes)) {
            udfCallback();
            return;
          }

          udfBuilder.create_udf(udfKey, options.udfs[udfKey], udfCallback);
        });
      });
    }).then(function () {
      callback();
    }).catch(function (err) {
      callback(err);
    });
  },

  _assert_user_defined_aggregates(callback) {
    var client = this._define_connection;
    var options = this._options;
    var keyspace = this._keyspace;

    if (!options.udas) {
      callback();
      return;
    }

    var udaBuilder = new UdaBuilder(client);

    Promise.mapSeries(Object.keys(options.udas), function (udaKey) {
      return new Promise(function (resolve, reject) {
        var udaCallback = function udaCallback(err) {
          if (err) {
            reject(err);
            return;
          }
          resolve();
        };

        udaBuilder.validate_definition(udaKey, options.udas[udaKey]);

        if (!options.udas[udaKey].initcond) {
          options.udas[udaKey].initcond = null;
        }

        udaBuilder.get_uda(udaKey, keyspace, function (err, udaObjects) {
          if (err) {
            udaCallback(err);
            return;
          }

          if (!udaObjects) {
            udaBuilder.create_uda(udaKey, options.udas[udaKey], udaCallback);
            return;
          }

          var inputTypes = _.map(options.udas[udaKey].input_types, normalizer.normalize_user_defined_type);
          var sfunc = options.udas[udaKey].sfunc.toLowerCase();
          var stype = normalizer.normalize_user_defined_type(options.udas[udaKey].stype);
          var finalfunc = options.udas[udaKey].finalfunc ? options.udas[udaKey].finalfunc.toLowerCase() : null;
          var initcond = options.udas[udaKey].initcond ? options.udas[udaKey].initcond.replace(/[\s]/g, '') : null;

          for (var i = 0; i < udaObjects.length; i++) {
            var resultArgumentTypes = _.map(udaObjects[i].argument_types, normalizer.normalize_user_defined_type);

            var resultStateFunc = udaObjects[i].state_func;
            var resultStateType = normalizer.normalize_user_defined_type(udaObjects[i].state_type);
            var resultFinalFunc = udaObjects[i].final_func;
            var resultInitcond = udaObjects[i].initcond ? udaObjects[i].initcond.replace(/[\s]/g, '') : null;

            if (sfunc === resultStateFunc && stype === resultStateType && finalfunc === resultFinalFunc && initcond === resultInitcond && _.isEqual(inputTypes, resultArgumentTypes)) {
              udaCallback();
              return;
            }
          }
          udaBuilder.create_uda(udaKey, options.udas[udaKey], udaCallback);
        });
      });
    }).then(function () {
      callback();
    }).catch(function (err) {
      callback(err);
    });
  },

  _set_client(client) {
    var _this = this;

    var defineConnectionOptions = _.cloneDeep(this._connection);

    this._client = client;
    this._define_connection = new cql.Client(defineConnectionOptions);

    // Reset connections on all models
    Object.keys(this._models).forEach(function (i) {
      _this._models[i]._properties.cql = _this._client;
      _this._models[i]._properties.define_connection = _this._define_connection;
    });
  },

  init(callback) {
    var _this2 = this;

    var onUserDefinedAggregates = function onUserDefinedAggregates(err) {
      if (err) {
        callback(err);
        return;
      }

      var managementTasks = [];
      if (_this2._keyspace && _this2._options.manageESIndex) {
        _this2.assertESIndexAsync = Promise.promisify(_this2._assert_es_index);
        managementTasks.push(_this2.assertESIndexAsync());
      }
      if (_this2._keyspace && _this2._options.manageGraphs) {
        _this2.assertGremlinGraphAsync = Promise.promisify(_this2._assert_gremlin_graph);
        managementTasks.push(_this2.assertGremlinGraphAsync());
      }
      Promise.all(managementTasks).then(function () {
        callback(null, _this2);
      }).catch(function (err1) {
        callback(err1);
      });
    };

    var onUserDefinedFunctions = function f(err) {
      if (err) {
        callback(err);
        return;
      }
      try {
        this._assert_user_defined_aggregates(onUserDefinedAggregates.bind(this));
      } catch (e) {
        throw buildError('model.validator.invaliduda', e.message);
      }
    };

    var onUserDefinedTypes = function f(err) {
      if (err) {
        callback(err);
        return;
      }
      try {
        this._assert_user_defined_functions(onUserDefinedFunctions.bind(this));
      } catch (e) {
        throw buildError('model.validator.invalidudf', e.message);
      }
    };

    var onKeyspace = function f(err) {
      if (err) {
        callback(err);
        return;
      }
      this._set_client(new cql.Client(this._connection));
      try {
        this._assert_user_defined_types(onUserDefinedTypes.bind(this));
      } catch (e) {
        throw buildError('model.validator.invalidudt', e.message);
      }
    };

    if (this._keyspace && this._options.createKeyspace !== false) {
      this._assert_keyspace(onKeyspace.bind(this));
    } else {
      onKeyspace.call(this);
    }
  },

  addModel(modelName, modelSchema) {
    if (!modelName || typeof modelName !== 'string') {
      throw buildError('model.validator.invalidschema', 'Model name must be a valid string');
    }

    try {
      schemer.validate_model_schema(modelSchema);
    } catch (e) {
      throw buildError('model.validator.invalidschema', e.message);
    }

    if (modelSchema.options && modelSchema.options.timestamps) {
      var timestampOptions = {
        createdAt: modelSchema.options.timestamps.createdAt || 'createdAt',
        updatedAt: modelSchema.options.timestamps.updatedAt || 'updatedAt'
      };
      modelSchema.options.timestamps = timestampOptions;

      modelSchema.fields[modelSchema.options.timestamps.createdAt] = {
        type: 'timestamp',
        default: {
          $db_function: 'toTimestamp(now())'
        }
      };
      modelSchema.fields[modelSchema.options.timestamps.updatedAt] = {
        type: 'timestamp',
        default: {
          $db_function: 'toTimestamp(now())'
        }
      };
    }

    if (modelSchema.options && modelSchema.options.versions) {
      var versionOptions = {
        key: modelSchema.options.versions.key || '__v'
      };
      modelSchema.options.versions = versionOptions;

      modelSchema.fields[modelSchema.options.versions.key] = {
        type: 'timeuuid',
        default: {
          $db_function: 'now()'
        }
      };
    }

    var baseProperties = {
      name: modelName,
      schema: modelSchema,
      keyspace: this._keyspace,
      define_connection: this._define_connection,
      cql: this._client,
      esclient: this._esclient,
      gremlin_client: this._gremlin_client,
      get_constructor: this.getModel.bind(this, modelName),
      init: this.init.bind(this),
      dropTableOnSchemaChange: this._options.dropTableOnSchemaChange,
      createTable: this._options.createTable,
      migration: this._options.migration,
      disableTTYConfirmation: this._options.disableTTYConfirmation
    };

    this._models[modelName] = this._generate_model(baseProperties);
    return this._models[modelName];
  },

  getModel(modelName) {
    return this._models[modelName] || null;
  },

  close(callback) {
    callback = callback || noop;

    if (this.orm._esclient) {
      this.orm._esclient.close();
    }

    if (this.orm._gremlin_client && this.orm._gremlin_client.connection && this.orm._gremlin_client.connection.ws) {
      this.orm._gremlin_client.connection.ws.close();
    }

    var clientsToShutdown = [];
    if (this.orm._client) {
      clientsToShutdown.push(this.orm._client.shutdown());
    }
    if (this.orm._define_connection) {
      clientsToShutdown.push(this.orm._define_connection.shutdown());
    }

    Promise.all(clientsToShutdown).then(function () {
      callback();
    }).catch(function (err) {
      callback(err);
    });
  }
};

module.exports = Apollo;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9vcm0vYXBvbGxvLmpzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwidXRpbCIsIl8iLCJlbGFzdGljc2VhcmNoIiwiZSIsImdyZW1saW4iLCJkc2VEcml2ZXIiLCJjcWwiLCJwcm9taXNpZnlBbGwiLCJCYXNlTW9kZWwiLCJzY2hlbWVyIiwibm9ybWFsaXplciIsImJ1aWxkRXJyb3IiLCJLZXlzcGFjZUJ1aWxkZXIiLCJVZHRCdWlsZGVyIiwiVWRmQnVpbGRlciIsIlVkYUJ1aWxkZXIiLCJFbGFzc2FuZHJhQnVpbGRlciIsIkphbnVzR3JhcGhCdWlsZGVyIiwiREVGQVVMVF9SRVBMSUNBVElPTl9GQUNUT1IiLCJub29wIiwiQXBvbGxvIiwiZiIsImNvbm5lY3Rpb24iLCJvcHRpb25zIiwiZGVmYXVsdFJlcGxpY2F0aW9uU3RyYXRlZ3kiLCJjbGFzcyIsInJlcGxpY2F0aW9uX2ZhY3RvciIsIl9vcHRpb25zIiwiX21vZGVscyIsIl9rZXlzcGFjZSIsImtleXNwYWNlIiwiX2Nvbm5lY3Rpb24iLCJfY2xpZW50IiwiX2VzY2xpZW50IiwiX2dyZW1saW5fY2xpZW50IiwicHJvdG90eXBlIiwiX2dlbmVyYXRlX21vZGVsIiwicHJvcGVydGllcyIsIk1vZGVsIiwiYXJncyIsImFwcGx5IiwiQXJyYXkiLCJzbGljZSIsImNhbGwiLCJpbmhlcml0cyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwia2V5IiwiX3NldF9wcm9wZXJ0aWVzIiwiY3JlYXRlX2VzX2NsaWVudCIsIkVycm9yIiwiY29udGFjdFBvaW50cyIsImRlZmF1bHRIb3N0cyIsImhvc3QiLCJwdXNoIiwiZXNDbGllbnRDb25maWciLCJkZWZhdWx0cyIsImhvc3RzIiwic25pZmZPblN0YXJ0IiwiQ2xpZW50IiwiX2Fzc2VydF9lc19pbmRleCIsImNhbGxiYWNrIiwiZXNDbGllbnQiLCJpbmRleE5hbWUiLCJlbGFzc2FuZHJhQnVpbGRlciIsImFzc2VydF9pbmRleCIsImNyZWF0ZV9ncmVtbGluX2NsaWVudCIsImdyZW1saW5Db25maWciLCJwb3J0IiwiY3JlYXRlQ2xpZW50IiwiX2Fzc2VydF9ncmVtbGluX2dyYXBoIiwiZ3JlbWxpbkNsaWVudCIsImtleXNwYWNlTmFtZSIsImdyYXBoTmFtZSIsImdyYXBoQnVpbGRlciIsImFzc2VydF9ncmFwaCIsImdldF9zeXN0ZW1fY2xpZW50IiwiY2xvbmVEZWVwIiwiZ2V0X2tleXNwYWNlX25hbWUiLCJfYXNzZXJ0X2tleXNwYWNlIiwiY2xpZW50Iiwia2V5c3BhY2VCdWlsZGVyIiwiZ2V0X2tleXNwYWNlIiwiZXJyIiwia2V5c3BhY2VPYmplY3QiLCJjcmVhdGVfa2V5c3BhY2UiLCJkYlJlcGxpY2F0aW9uIiwibm9ybWFsaXplX3JlcGxpY2F0aW9uX29wdGlvbiIsInJlcGxpY2F0aW9uIiwib3JtUmVwbGljYXRpb24iLCJpc0VxdWFsIiwiYWx0ZXJfa2V5c3BhY2UiLCJzaHV0ZG93biIsIl9hc3NlcnRfdXNlcl9kZWZpbmVkX3R5cGVzIiwiX2RlZmluZV9jb25uZWN0aW9uIiwidWR0cyIsInVkdEJ1aWxkZXIiLCJtYXBTZXJpZXMiLCJ1ZHRLZXkiLCJyZXNvbHZlIiwicmVqZWN0IiwidWR0Q2FsbGJhY2siLCJnZXRfdWR0IiwidWR0T2JqZWN0IiwiY3JlYXRlX3VkdCIsInVkdEtleXMiLCJ1ZHRWYWx1ZXMiLCJtYXAiLCJ2YWx1ZXMiLCJub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUiLCJmaWVsZE5hbWVzIiwiZmllbGRfbmFtZXMiLCJmaWVsZFR5cGVzIiwiZmllbGRfdHlwZXMiLCJkaWZmZXJlbmNlIiwibGVuZ3RoIiwiZm9ybWF0IiwidGhlbiIsImNhdGNoIiwiX2Fzc2VydF91c2VyX2RlZmluZWRfZnVuY3Rpb25zIiwidWRmcyIsInVkZkJ1aWxkZXIiLCJ1ZGZLZXkiLCJ1ZGZDYWxsYmFjayIsInZhbGlkYXRlX2RlZmluaXRpb24iLCJnZXRfdWRmIiwidWRmT2JqZWN0IiwiY3JlYXRlX3VkZiIsInVkZkxhbmd1YWdlIiwibGFuZ3VhZ2UiLCJyZXN1bHRMYW5ndWFnZSIsInVkZkNvZGUiLCJjb2RlIiwicmVzdWx0Q29kZSIsImJvZHkiLCJ1ZGZSZXR1cm5UeXBlIiwicmV0dXJuVHlwZSIsInJlc3VsdFJldHVyblR5cGUiLCJyZXR1cm5fdHlwZSIsInVkZklucHV0cyIsImlucHV0cyIsInVkZklucHV0S2V5cyIsInVkZklucHV0VmFsdWVzIiwicmVzdWx0QXJndW1lbnROYW1lcyIsImFyZ3VtZW50X25hbWVzIiwicmVzdWx0QXJndW1lbnRUeXBlcyIsImFyZ3VtZW50X3R5cGVzIiwiX2Fzc2VydF91c2VyX2RlZmluZWRfYWdncmVnYXRlcyIsInVkYXMiLCJ1ZGFCdWlsZGVyIiwidWRhS2V5IiwidWRhQ2FsbGJhY2siLCJpbml0Y29uZCIsImdldF91ZGEiLCJ1ZGFPYmplY3RzIiwiY3JlYXRlX3VkYSIsImlucHV0VHlwZXMiLCJpbnB1dF90eXBlcyIsInNmdW5jIiwidG9Mb3dlckNhc2UiLCJzdHlwZSIsImZpbmFsZnVuYyIsInJlcGxhY2UiLCJpIiwicmVzdWx0U3RhdGVGdW5jIiwic3RhdGVfZnVuYyIsInJlc3VsdFN0YXRlVHlwZSIsInN0YXRlX3R5cGUiLCJyZXN1bHRGaW5hbEZ1bmMiLCJmaW5hbF9mdW5jIiwicmVzdWx0SW5pdGNvbmQiLCJfc2V0X2NsaWVudCIsImRlZmluZUNvbm5lY3Rpb25PcHRpb25zIiwiX3Byb3BlcnRpZXMiLCJkZWZpbmVfY29ubmVjdGlvbiIsImluaXQiLCJvblVzZXJEZWZpbmVkQWdncmVnYXRlcyIsIm1hbmFnZW1lbnRUYXNrcyIsIm1hbmFnZUVTSW5kZXgiLCJhc3NlcnRFU0luZGV4QXN5bmMiLCJwcm9taXNpZnkiLCJtYW5hZ2VHcmFwaHMiLCJhc3NlcnRHcmVtbGluR3JhcGhBc3luYyIsImFsbCIsImVycjEiLCJvblVzZXJEZWZpbmVkRnVuY3Rpb25zIiwiYmluZCIsIm1lc3NhZ2UiLCJvblVzZXJEZWZpbmVkVHlwZXMiLCJvbktleXNwYWNlIiwiY3JlYXRlS2V5c3BhY2UiLCJhZGRNb2RlbCIsIm1vZGVsTmFtZSIsIm1vZGVsU2NoZW1hIiwidmFsaWRhdGVfbW9kZWxfc2NoZW1hIiwidGltZXN0YW1wcyIsInRpbWVzdGFtcE9wdGlvbnMiLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJmaWVsZHMiLCJ0eXBlIiwiZGVmYXVsdCIsIiRkYl9mdW5jdGlvbiIsInZlcnNpb25zIiwidmVyc2lvbk9wdGlvbnMiLCJiYXNlUHJvcGVydGllcyIsIm5hbWUiLCJzY2hlbWEiLCJlc2NsaWVudCIsImdyZW1saW5fY2xpZW50IiwiZ2V0X2NvbnN0cnVjdG9yIiwiZ2V0TW9kZWwiLCJkcm9wVGFibGVPblNjaGVtYUNoYW5nZSIsImNyZWF0ZVRhYmxlIiwibWlncmF0aW9uIiwiZGlzYWJsZVRUWUNvbmZpcm1hdGlvbiIsImNsb3NlIiwib3JtIiwid3MiLCJjbGllbnRzVG9TaHV0ZG93biIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsVUFBVUMsUUFBUSxVQUFSLENBQWhCO0FBQ0EsSUFBTUMsT0FBT0QsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNRSxJQUFJRixRQUFRLFFBQVIsQ0FBVjs7QUFFQSxJQUFJRyxzQkFBSjtBQUNBLElBQUk7QUFDRjtBQUNBQSxrQkFBZ0JILFFBQVEsZUFBUixDQUFoQjtBQUNELENBSEQsQ0FHRSxPQUFPSSxDQUFQLEVBQVU7QUFDVkQsa0JBQWdCLElBQWhCO0FBQ0Q7O0FBRUQsSUFBSUUsZ0JBQUo7QUFDQSxJQUFJO0FBQ0Y7QUFDQUEsWUFBVUwsUUFBUSxTQUFSLENBQVY7QUFDRCxDQUhELENBR0UsT0FBT0ksQ0FBUCxFQUFVO0FBQ1ZDLFlBQVUsSUFBVjtBQUNEOztBQUVELElBQUlDLGtCQUFKO0FBQ0EsSUFBSTtBQUNGO0FBQ0FBLGNBQVlOLFFBQVEsWUFBUixDQUFaO0FBQ0QsQ0FIRCxDQUdFLE9BQU9JLENBQVAsRUFBVTtBQUNWRSxjQUFZLElBQVo7QUFDRDs7QUFFRCxJQUFNQyxNQUFNUixRQUFRUyxZQUFSLENBQXFCRixhQUFh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TCxLQUFuQjtBQUNEOztBQUVELFFBQUksS0FBS0MsR0FBTCxDQUFTeEwsZUFBVCxJQUE0QixLQUFLd0wsR0FBTCxDQUFTeEwsZUFBVCxDQUF5QlosVUFBckQsSUFBbUUsS0FBS29NLEdBQUwsQ0FBU3hMLGVBQVQsQ0FBeUJaLFVBQXpCLENBQW9DcU0sRUFBM0csRUFBK0c7QUFDN0csV0FBS0QsR0FBTCxDQUFTeEwsZUFBVCxDQUF5QlosVUFBekIsQ0FBb0NxTSxFQUFwQyxDQUF1Q0YsS0FBdkM7QUFDRDs7QUFFRCxRQUFNRyxvQkFBb0IsRUFBMUI7QUFDQSxRQUFJLEtBQUtGLEdBQUwsQ0FBUzFMLE9BQWIsRUFBc0I7QUFDcEI0TCx3QkFBa0JySyxJQUFsQixDQUF1QixLQUFLbUssR0FBTCxDQUFTMUwsT0FBVCxDQUFpQjZELFFBQWpCLEVBQXZCO0FBQ0Q7QUFDRCxRQUFJLEtBQUs2SCxHQUFMLENBQVMzSCxrQkFBYixFQUFpQztBQUMvQjZILHdCQUFrQnJLLElBQWxCLENBQXVCLEtBQUttSyxHQUFMLENBQVMzSCxrQkFBVCxDQUE0QkYsUUFBNUIsRUFBdkI7QUFDRDs7QUFFRC9GLFlBQVEwTCxHQUFSLENBQVlvQyxpQkFBWixFQUNHdEcsSUFESCxDQUNRLFlBQU07QUFDVnhEO0FBQ0QsS0FISCxFQUlHeUQsS0FKSCxDQUlTLFVBQUNuQyxHQUFELEVBQVM7QUFDZHRCLGVBQVNzQixHQUFUO0FBQ0QsS0FOSDtBQU9EO0FBNWVnQixDQUFuQjs7QUErZUF5SSxPQUFPQyxPQUFQLEdBQWlCMU0sTUFBakIiLCJmaWxlIjoiYXBvbGxvLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuXG5sZXQgZWxhc3RpY3NlYXJjaDtcbnRyeSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZXh0cmFuZW91cy1kZXBlbmRlbmNpZXMsIGltcG9ydC9uby11bnJlc29sdmVkXG4gIGVsYXN0aWNzZWFyY2ggPSByZXF1aXJlKCdlbGFzdGljc2VhcmNoJyk7XG59IGNhdGNoIChlKSB7XG4gIGVsYXN0aWNzZWFyY2ggPSBudWxsO1xufVxuXG5sZXQgZ3JlbWxpbjtcbnRyeSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZXh0cmFuZW91cy1kZXBlbmRlbmNpZXMsIGltcG9ydC9uby11bnJlc29sdmVkXG4gIGdyZW1saW4gPSByZXF1aXJlKCdncmVtbGluJyk7XG59IGNhdGNoIChlKSB7XG4gIGdyZW1saW4gPSBudWxsO1xufVxuXG5sZXQgZHNlRHJpdmVyO1xudHJ5IHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1leHRyYW5lb3VzLWRlcGVuZGVuY2llcywgaW1wb3J0L25vLXVucmVzb2x2ZWRcbiAgZHNlRHJpdmVyID0gcmVxdWlyZSgnZHNlLWRyaXZlcicpO1xufSBjYXRjaCAoZSkge1xuICBkc2VEcml2ZXIgPSBudWxsO1xufVxuXG5jb25zdCBjcWwgPSBQcm9taXNlLnByb21pc2lmeUFsbChkc2VEcml2ZXIgfHwgcmVxdWlyZSgnY2Fzc2FuZHJhLWRyaXZlcicpKTtcblxuY29uc3QgQmFzZU1vZGVsID0gcmVxdWlyZSgnLi9iYXNlX21vZGVsJyk7XG5jb25zdCBzY2hlbWVyID0gcmVxdWlyZSgnLi4vdmFsaWRhdG9ycy9zY2hlbWEnKTtcbmNvbnN0IG5vcm1hbGl6ZXIgPSByZXF1aXJlKCcuLi91dGlscy9ub3JtYWxpemVyJyk7XG5jb25zdCBidWlsZEVycm9yID0gcmVxdWlyZSgnLi9hcG9sbG9fZXJyb3IuanMnKTtcblxuY29uc3QgS2V5c3BhY2VCdWlsZGVyID0gcmVxdWlyZSgnLi4vYnVpbGRlcnMva2V5c3BhY2UnKTtcbmNvbnN0IFVkdEJ1aWxkZXIgPSByZXF1aXJlKCcuLi9idWlsZGVycy91ZHQnKTtcbmNvbnN0IFVkZkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9idWlsZGVycy91ZGYnKTtcbmNvbnN0IFVkYUJ1aWxkZXIgPSByZXF1aXJlKCcuLi9idWlsZGVycy91ZGEnKTtcbmNvbnN0IEVsYXNzYW5kcmFCdWlsZGVyID0gcmVxdWlyZSgnLi4vYnVpbGRlcnMvZWxhc3NhbmRyYScpO1xuY29uc3QgSmFudXNHcmFwaEJ1aWxkZXIgPSByZXF1aXJlKCcuLi9idWlsZGVycy9qYW51c2dyYXBoJyk7XG5cbmNvbnN0IERFRkFVTFRfUkVQTElDQVRJT05fRkFDVE9SID0gMTtcblxuY29uc3Qgbm9vcCA9ICgpID0+IHt9O1xuXG5jb25zdCBBcG9sbG8gPSBmdW5jdGlvbiBmKGNvbm5lY3Rpb24sIG9wdGlvbnMpIHtcbiAgaWYgKCFjb25uZWN0aW9uKSB7XG4gICAgdGhyb3cgKGJ1aWxkRXJyb3IoJ21vZGVsLnZhbGlkYXRvci5pbnZhbGlkY29uZmlnJywgJ0Nhc3NhbmRyYSBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24gdW5kZWZpbmVkJykpO1xuICB9XG5cbiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG5cbiAgaWYgKCFvcHRpb25zLmRlZmF1bHRSZXBsaWNhdGlvblN0cmF0ZWd5KSB7XG4gICAgb3B0aW9ucy5kZWZhdWx0UmVwbGljYXRpb25TdHJhdGVneSA9IHtcbiAgICAgIGNsYXNzOiAnU2ltcGxlU3RyYXRlZ3knLFxuICAgICAgcmVwbGljYXRpb25fZmFjdG9yOiBERUZBVUxUX1JFUExJQ0FUSU9OX0ZBQ1RPUixcbiAgICB9O1xuICB9XG5cbiAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gIHRoaXMuX21vZGVscyA9IHt9O1xuICB0aGlzLl9rZXlzcGFjZSA9IGNvbm5lY3Rpb24ua2V5c3BhY2U7XG4gIHRoaXMuX2Nvbm5lY3Rpb24gPSBjb25uZWN0aW9uO1xuICB0aGlzLl9jbGllbnQgPSBudWxsO1xuICB0aGlzLl9lc2NsaWVudCA9IG51bGw7XG4gIHRoaXMuX2dyZW1saW5fY2xpZW50ID0gbnVsbDtcbn07XG5cbkFwb2xsby5wcm90b3R5cGUgPSB7XG5cbiAgX2dlbmVyYXRlX21vZGVsKHByb3BlcnRpZXMpIHtcbiAgICBjb25zdCBNb2RlbCA9IGZ1bmN0aW9uIGYoLi4uYXJncykge1xuICAgICAgQmFzZU1vZGVsLmFwcGx5KHRoaXMsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3MpKTtcbiAgICB9O1xuXG4gICAgdXRpbC5pbmhlcml0cyhNb2RlbCwgQmFzZU1vZGVsKTtcblxuICAgIE9iamVjdC5rZXlzKEJhc2VNb2RlbCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBNb2RlbFtrZXldID0gQmFzZU1vZGVsW2tleV07XG4gICAgfSk7XG5cbiAgICBNb2RlbC5fc2V0X3Byb3BlcnRpZXMocHJvcGVydGllcyk7XG5cbiAgICByZXR1cm4gTW9kZWw7XG4gIH0sXG5cbiAgY3JlYXRlX2VzX2NsaWVudCgpIHtcbiAgICBpZiAoIWVsYXN0aWNzZWFyY2gpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ0NvbmZpZ3VyZWQgdG8gdXNlIGVsYXNzYW5kcmEsIGJ1dCBlbGFzdGljc2VhcmNoIG1vZHVsZSB3YXMgbm90IGZvdW5kLCB0cnkgbnBtIGluc3RhbGwgZWxhc3RpY3NlYXJjaCcpKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250YWN0UG9pbnRzID0gdGhpcy5fY29ubmVjdGlvbi5jb250YWN0UG9pbnRzO1xuICAgIGNvbnN0IGRlZmF1bHRIb3N0cyA9IFtdO1xuICAgIGNvbnRhY3RQb2ludHMuZm9yRWFjaCgoaG9zdCkgPT4ge1xuICAgICAgZGVmYXVsdEhvc3RzLnB1c2goeyBob3N0IH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZXNDbGllbnRDb25maWcgPSBfLmRlZmF1bHRzKHRoaXMuX2Nvbm5lY3Rpb24uZWxhc3RpY3NlYXJjaCwge1xuICAgICAgaG9zdHM6IGRlZmF1bHRIb3N0cyxcbiAgICAgIHNuaWZmT25TdGFydDogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLl9lc2NsaWVudCA9IG5ldyBlbGFzdGljc2VhcmNoLkNsaWVudChlc0NsaWVudENvbmZpZyk7XG4gICAgcmV0dXJuIHRoaXMuX2VzY2xpZW50O1xuICB9LFxuXG4gIF9hc3NlcnRfZXNfaW5kZXgoY2FsbGJhY2spIHtcbiAgICBjb25zdCBlc0NsaWVudCA9IHRoaXMuY3JlYXRlX2VzX2NsaWVudCgpO1xuICAgIGNvbnN0IGluZGV4TmFtZSA9IHRoaXMuX2tleXNwYWNlO1xuXG4gICAgY29uc3QgZWxhc3NhbmRyYUJ1aWxkZXIgPSBuZXcgRWxhc3NhbmRyYUJ1aWxkZXIoZXNDbGllbnQpO1xuICAgIGVsYXNzYW5kcmFCdWlsZGVyLmFzc2VydF9pbmRleChpbmRleE5hbWUsIGNhbGxiYWNrKTtcbiAgfSxcblxuICBjcmVhdGVfZ3JlbWxpbl9jbGllbnQoKSB7XG4gICAgaWYgKCFncmVtbGluKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKCdDb25maWd1cmVkIHRvIHVzZSBqYW51cyBncmFwaCBzZXJ2ZXIsIGJ1dCBncmVtbGluIG1vZHVsZSB3YXMgbm90IGZvdW5kLCB0cnkgbnBtIGluc3RhbGwgZ3JlbWxpbicpKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250YWN0UG9pbnRzID0gdGhpcy5fY29ubmVjdGlvbi5jb250YWN0UG9pbnRzO1xuICAgIGNvbnN0IGRlZmF1bHRIb3N0cyA9IFtdO1xuICAgIGNvbnRhY3RQb2ludHMuZm9yRWFjaCgoaG9zdCkgPT4ge1xuICAgICAgZGVmYXVsdEhvc3RzLnB1c2goeyBob3N0IH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZ3JlbWxpbkNvbmZpZyA9IF8uZGVmYXVsdHModGhpcy5fY29ubmVjdGlvbi5ncmVtbGluLCB7XG4gICAgICBob3N0OiBkZWZhdWx0SG9zdHNbMF0sXG4gICAgICBwb3J0OiA4MTgyLFxuICAgICAgb3B0aW9uczoge30sXG4gICAgfSk7XG4gICAgdGhpcy5fZ3JlbWxpbl9jbGllbnQgPSBncmVtbGluLmNyZWF0ZUNsaWVudChncmVtbGluQ29uZmlnLnBvcnQsIGdyZW1saW5Db25maWcuaG9zdCwgZ3JlbWxpbkNvbmZpZy5vcHRpb25zKTtcbiAgICByZXR1cm4gdGhpcy5fZ3JlbWxpbl9jbGllbnQ7XG4gIH0sXG5cbiAgX2Fzc2VydF9ncmVtbGluX2dyYXBoKGNhbGxiYWNrKSB7XG4gICAgY29uc3QgZ3JlbWxpbkNsaWVudCA9IHRoaXMuY3JlYXRlX2dyZW1saW5fY2xpZW50KCk7XG4gICAgY29uc3Qga2V5c3BhY2VOYW1lID0gdGhpcy5fa2V5c3BhY2U7XG4gICAgY29uc3QgZ3JhcGhOYW1lID0gYCR7a2V5c3BhY2VOYW1lfV9ncmFwaGA7XG5cbiAgICBjb25zdCBncmFwaEJ1aWxkZXIgPSBuZXcgSmFudXNHcmFwaEJ1aWxkZXIoZ3JlbWxpbkNsaWVudCk7XG4gICAgZ3JhcGhCdWlsZGVyLmFzc2VydF9ncmFwaChncmFwaE5hbWUsIGNhbGxiYWNrKTtcbiAgfSxcblxuICBnZXRfc3lzdGVtX2NsaWVudCgpIHtcbiAgICBjb25zdCBjb25uZWN0aW9uID0gXy5jbG9uZURlZXAodGhpcy5fY29ubmVjdGlvbik7XG4gICAgZGVsZXRlIGNvbm5lY3Rpb24ua2V5c3BhY2U7XG5cbiAgICByZXR1cm4gbmV3IGNxbC5DbGllbnQoY29ubmVjdGlvbik7XG4gIH0sXG5cbiAgZ2V0X2tleXNwYWNlX25hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2tleXNwYWNlO1xuICB9LFxuXG4gIF9hc3NlcnRfa2V5c3BhY2UoY2FsbGJhY2spIHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmdldF9zeXN0ZW1fY2xpZW50KCk7XG4gICAgY29uc3Qga2V5c3BhY2VOYW1lID0gdGhpcy5fa2V5c3BhY2U7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuX29wdGlvbnM7XG5cbiAgICBjb25zdCBrZXlzcGFjZUJ1aWxkZXIgPSBuZXcgS2V5c3BhY2VCdWlsZGVyKGNsaWVudCk7XG5cbiAgICBrZXlzcGFjZUJ1aWxkZXIuZ2V0X2tleXNwYWNlKGtleXNwYWNlTmFtZSwgKGVyciwga2V5c3BhY2VPYmplY3QpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWtleXNwYWNlT2JqZWN0KSB7XG4gICAgICAgIGtleXNwYWNlQnVpbGRlci5jcmVhdGVfa2V5c3BhY2Uoa2V5c3BhY2VOYW1lLCBvcHRpb25zLmRlZmF1bHRSZXBsaWNhdGlvblN0cmF0ZWd5LCBjYWxsYmFjayk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGJSZXBsaWNhdGlvbiA9IG5vcm1hbGl6ZXIubm9ybWFsaXplX3JlcGxpY2F0aW9uX29wdGlvbihrZXlzcGFjZU9iamVjdC5yZXBsaWNhdGlvbik7XG4gICAgICBjb25zdCBvcm1SZXBsaWNhdGlvbiA9IG5vcm1hbGl6ZXIubm9ybWFsaXplX3JlcGxpY2F0aW9uX29wdGlvbihvcHRpb25zLmRlZmF1bHRSZXBsaWNhdGlvblN0cmF0ZWd5KTtcblxuICAgICAgaWYgKCFfLmlzRXF1YWwoZGJSZXBsaWNhdGlvbiwgb3JtUmVwbGljYXRpb24pKSB7XG4gICAgICAgIGtleXNwYWNlQnVpbGRlci5hbHRlcl9rZXlzcGFjZShrZXlzcGFjZU5hbWUsIG9wdGlvbnMuZGVmYXVsdFJlcGxpY2F0aW9uU3RyYXRlZ3ksIGNhbGxiYWNrKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjbGllbnQuc2h1dGRvd24oKCkgPT4ge1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgX2Fzc2VydF91c2VyX2RlZmluZWRfdHlwZXMoY2FsbGJhY2spIHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLl9kZWZpbmVfY29ubmVjdGlvbjtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5fb3B0aW9ucztcbiAgICBjb25zdCBrZXlzcGFjZSA9IHRoaXMuX2tleXNwYWNlO1xuXG4gICAgaWYgKCFvcHRpb25zLnVkdHMpIHtcbiAgICAgIGNhbGxiYWNrKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdWR0QnVpbGRlciA9IG5ldyBVZHRCdWlsZGVyKGNsaWVudCk7XG5cbiAgICBQcm9taXNlLm1hcFNlcmllcyhPYmplY3Qua2V5cyhvcHRpb25zLnVkdHMpLCAodWR0S2V5KSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB1ZHRDYWxsYmFjayA9IChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9O1xuICAgICAgdWR0QnVpbGRlci5nZXRfdWR0KHVkdEtleSwga2V5c3BhY2UsIChlcnIsIHVkdE9iamVjdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgdWR0Q2FsbGJhY2soZXJyKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXVkdE9iamVjdCkge1xuICAgICAgICAgIHVkdEJ1aWxkZXIuY3JlYXRlX3VkdCh1ZHRLZXksIG9wdGlvbnMudWR0c1t1ZHRLZXldLCB1ZHRDYWxsYmFjayk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdWR0S2V5cyA9IE9iamVjdC5rZXlzKG9wdGlvbnMudWR0c1t1ZHRLZXldKTtcbiAgICAgICAgY29uc3QgdWR0VmFsdWVzID0gXy5tYXAoXy52YWx1ZXMob3B0aW9ucy51ZHRzW3VkdEtleV0pLCBub3JtYWxpemVyLm5vcm1hbGl6ZV91c2VyX2RlZmluZWRfdHlwZSk7XG4gICAgICAgIGNvbnN0IGZpZWxkTmFtZXMgPSB1ZHRPYmplY3QuZmllbGRfbmFtZXM7XG4gICAgICAgIGNvbnN0IGZpZWxkVHlwZXMgPSBfLm1hcCh1ZHRPYmplY3QuZmllbGRfdHlwZXMsIG5vcm1hbGl6ZXIubm9ybWFsaXplX3VzZXJfZGVmaW5lZF90eXBlKTtcblxuICAgICAgICBpZiAoXy5kaWZmZXJlbmNlKHVkdEtleXMsIGZpZWxkTmFtZXMpLmxlbmd0aCA9PT0gMCAmJiBfLmRpZmZlcmVuY2UodWR0VmFsdWVzLCBmaWVsZFR5cGVzKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB1ZHRDYWxsYmFjaygpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoXG4gICAgICAgICAgJ1VzZXIgZGVmaW5lZCB0eXBlIFwiJXNcIiBhbHJlYWR5IGV4aXN0cyBidXQgZG9lcyBub3QgbWF0Y2ggdGhlIHVkdCBkZWZpbml0aW9uLiAnICtcbiAgICAgICAgICAnQ29uc2lkZXIgYWx0ZXJpbmcgb3IgZHJvcGluZyB0aGUgdHlwZS4nLFxuICAgICAgICAgIHVkdEtleSxcbiAgICAgICAgKSkpO1xuICAgICAgfSk7XG4gICAgfSkpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgIH0pO1xuICB9LFxuXG4gIF9hc3NlcnRfdXNlcl9kZWZpbmVkX2Z1bmN0aW9ucyhjYWxsYmFjaykge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuX2RlZmluZV9jb25uZWN0aW9uO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLl9vcHRpb25zO1xuICAgIGNvbnN0IGtleXNwYWNlID0gdGhpcy5fa2V5c3BhY2U7XG5cbiAgICBpZiAoIW9wdGlvbnMudWRmcykge1xuICAgICAgY2FsbGJhY2soKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB1ZGZCdWlsZGVyID0gbmV3IFVkZkJ1aWxkZXIoY2xpZW50KTtcblxuICAgIFByb21pc2UubWFwU2VyaWVzKE9iamVjdC5rZXlzKG9wdGlvbnMudWRmcyksICh1ZGZLZXkpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHVkZkNhbGxiYWNrID0gKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH07XG5cbiAgICAgIHVkZkJ1aWxkZXIudmFsaWRhdGVfZGVmaW5pdGlvbih1ZGZLZXksIG9wdGlvbnMudWRmc1t1ZGZLZXldKTtcblxuICAgICAgdWRmQnVpbGRlci5nZXRfdWRmKHVkZktleSwga2V5c3BhY2UsIChlcnIsIHVkZk9iamVjdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgdWRmQ2FsbGJhY2soZXJyKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXVkZk9iamVjdCkge1xuICAgICAgICAgIHVkZkJ1aWxkZXIuY3JlYXRlX3VkZih1ZGZLZXksIG9wdGlvbnMudWRmc1t1ZGZLZXldLCB1ZGZDYWxsYmFjayk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdWRmTGFuZ3VhZ2UgPSBvcHRpb25zLnVkZnNbdWRmS2V5XS5sYW5ndWFnZTtcbiAgICAgICAgY29uc3QgcmVzdWx0TGFuZ3VhZ2UgPSB1ZGZPYmplY3QubGFuZ3VhZ2U7XG5cbiAgICAgICAgY29uc3QgdWRmQ29kZSA9IG9wdGlvbnMudWRmc1t1ZGZLZXldLmNvZGU7XG4gICAgICAgIGNvbnN0IHJlc3VsdENvZGUgPSB1ZGZPYmplY3QuYm9keTtcblxuICAgICAgICBjb25zdCB1ZGZSZXR1cm5UeXBlID0gbm9ybWFsaXplci5ub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUob3B0aW9ucy51ZGZzW3VkZktleV0ucmV0dXJuVHlwZSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdFJldHVyblR5cGUgPSBub3JtYWxpemVyLm5vcm1hbGl6ZV91c2VyX2RlZmluZWRfdHlwZSh1ZGZPYmplY3QucmV0dXJuX3R5cGUpO1xuXG4gICAgICAgIGNvbnN0IHVkZklucHV0cyA9IG9wdGlvbnMudWRmc1t1ZGZLZXldLmlucHV0cyA/IG9wdGlvbnMudWRmc1t1ZGZLZXldLmlucHV0cyA6IHt9O1xuICAgICAgICBjb25zdCB1ZGZJbnB1dEtleXMgPSBPYmplY3Qua2V5cyh1ZGZJbnB1dHMpO1xuICAgICAgICBjb25zdCB1ZGZJbnB1dFZhbHVlcyA9IF8ubWFwKF8udmFsdWVzKHVkZklucHV0cyksIG5vcm1hbGl6ZXIubm9ybWFsaXplX3VzZXJfZGVmaW5lZF90eXBlKTtcbiAgICAgICAgY29uc3QgcmVzdWx0QXJndW1lbnROYW1lcyA9IHVkZk9iamVjdC5hcmd1bWVudF9uYW1lcztcbiAgICAgICAgY29uc3QgcmVzdWx0QXJndW1lbnRUeXBlcyA9IF8ubWFwKHVkZk9iamVjdC5hcmd1bWVudF90eXBlcywgbm9ybWFsaXplci5ub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUpO1xuXG4gICAgICAgIGlmICh1ZGZMYW5ndWFnZSA9PT0gcmVzdWx0TGFuZ3VhZ2UgJiZcbiAgICAgICAgICB1ZGZDb2RlID09PSByZXN1bHRDb2RlICYmXG4gICAgICAgICAgdWRmUmV0dXJuVHlwZSA9PT0gcmVzdWx0UmV0dXJuVHlwZSAmJlxuICAgICAgICAgIF8uaXNFcXVhbCh1ZGZJbnB1dEtleXMsIHJlc3VsdEFyZ3VtZW50TmFtZXMpICYmXG4gICAgICAgICAgXy5pc0VxdWFsKHVkZklucHV0VmFsdWVzLCByZXN1bHRBcmd1bWVudFR5cGVzKSkge1xuICAgICAgICAgIHVkZkNhbGxiYWNrKCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdWRmQnVpbGRlci5jcmVhdGVfdWRmKHVkZktleSwgb3B0aW9ucy51ZGZzW3VkZktleV0sIHVkZkNhbGxiYWNrKTtcbiAgICAgIH0pO1xuICAgIH0pKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICB9KTtcbiAgfSxcblxuICBfYXNzZXJ0X3VzZXJfZGVmaW5lZF9hZ2dyZWdhdGVzKGNhbGxiYWNrKSB7XG4gICAgY29uc3QgY2xpZW50ID0gdGhpcy5fZGVmaW5lX2Nvbm5lY3Rpb247XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuX29wdGlvbnM7XG4gICAgY29uc3Qga2V5c3BhY2UgPSB0aGlzLl9rZXlzcGFjZTtcblxuICAgIGlmICghb3B0aW9ucy51ZGFzKSB7XG4gICAgICBjYWxsYmFjaygpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHVkYUJ1aWxkZXIgPSBuZXcgVWRhQnVpbGRlcihjbGllbnQpO1xuXG4gICAgUHJvbWlzZS5tYXBTZXJpZXMoT2JqZWN0LmtleXMob3B0aW9ucy51ZGFzKSwgKHVkYUtleSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdWRhQ2FsbGJhY2sgPSAoZXJyKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfTtcblxuICAgICAgdWRhQnVpbGRlci52YWxpZGF0ZV9kZWZpbml0aW9uKHVkYUtleSwgb3B0aW9ucy51ZGFzW3VkYUtleV0pO1xuXG4gICAgICBpZiAoIW9wdGlvbnMudWRhc1t1ZGFLZXldLmluaXRjb25kKSB7XG4gICAgICAgIG9wdGlvbnMudWRhc1t1ZGFLZXldLmluaXRjb25kID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgdWRhQnVpbGRlci5nZXRfdWRhKHVkYUtleSwga2V5c3BhY2UsIChlcnIsIHVkYU9iamVjdHMpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHVkYUNhbGxiYWNrKGVycik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF1ZGFPYmplY3RzKSB7XG4gICAgICAgICAgdWRhQnVpbGRlci5jcmVhdGVfdWRhKHVkYUtleSwgb3B0aW9ucy51ZGFzW3VkYUtleV0sIHVkYUNhbGxiYWNrKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbnB1dFR5cGVzID0gXy5tYXAob3B0aW9ucy51ZGFzW3VkYUtleV0uaW5wdXRfdHlwZXMsIG5vcm1hbGl6ZXIubm9ybWFsaXplX3VzZXJfZGVmaW5lZF90eXBlKTtcbiAgICAgICAgY29uc3Qgc2Z1bmMgPSBvcHRpb25zLnVkYXNbdWRhS2V5XS5zZnVuYy50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBjb25zdCBzdHlwZSA9IG5vcm1hbGl6ZXIubm9ybWFsaXplX3VzZXJfZGVmaW5lZF90eXBlKG9wdGlvbnMudWRhc1t1ZGFLZXldLnN0eXBlKTtcbiAgICAgICAgY29uc3QgZmluYWxmdW5jID0gb3B0aW9ucy51ZGFzW3VkYUtleV0uZmluYWxmdW5jID8gb3B0aW9ucy51ZGFzW3VkYUtleV0uZmluYWxmdW5jLnRvTG93ZXJDYXNlKCkgOiBudWxsO1xuICAgICAgICBjb25zdCBpbml0Y29uZCA9IG9wdGlvbnMudWRhc1t1ZGFLZXldLmluaXRjb25kID8gb3B0aW9ucy51ZGFzW3VkYUtleV0uaW5pdGNvbmQucmVwbGFjZSgvW1xcc10vZywgJycpIDogbnVsbDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVkYU9iamVjdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCByZXN1bHRBcmd1bWVudFR5cGVzID0gXy5tYXAodWRhT2JqZWN0c1tpXS5hcmd1bWVudF90eXBlcywgbm9ybWFsaXplci5ub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUpO1xuXG4gICAgICAgICAgY29uc3QgcmVzdWx0U3RhdGVGdW5jID0gdWRhT2JqZWN0c1tpXS5zdGF0ZV9mdW5jO1xuICAgICAgICAgIGNvbnN0IHJlc3VsdFN0YXRlVHlwZSA9IG5vcm1hbGl6ZXIubm9ybWFsaXplX3VzZXJfZGVmaW5lZF90eXBlKHVkYU9iamVjdHNbaV0uc3RhdGVfdHlwZSk7XG4gICAgICAgICAgY29uc3QgcmVzdWx0RmluYWxGdW5jID0gdWRhT2JqZWN0c1tpXS5maW5hbF9mdW5jO1xuICAgICAgICAgIGNvbnN0IHJlc3VsdEluaXRjb25kID0gdWRhT2JqZWN0c1tpXS5pbml0Y29uZCA/IHVkYU9iamVjdHNbaV0uaW5pdGNvbmQucmVwbGFjZSgvW1xcc10vZywgJycpIDogbnVsbDtcblxuICAgICAgICAgIGlmIChzZnVuYyA9PT0gcmVzdWx0U3RhdGVGdW5jICYmXG4gICAgICAgICAgICBzdHlwZSA9PT0gcmVzdWx0U3RhdGVUeXBlICYmXG4gICAgICAgICAgICBmaW5hbGZ1bmMgPT09IHJlc3VsdEZpbmFsRnVuYyAmJlxuICAgICAgICAgICAgaW5pdGNvbmQgPT09IHJlc3VsdEluaXRjb25kICYmXG4gICAgICAgICAgICBfLmlzRXF1YWwoaW5wdXRUeXBlcywgcmVzdWx0QXJndW1lbnRUeXBlcykpIHtcbiAgICAgICAgICAgIHVkYUNhbGxiYWNrKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHVkYUJ1aWxkZXIuY3JlYXRlX3VkYSh1ZGFLZXksIG9wdGlvbnMudWRhc1t1ZGFLZXldLCB1ZGFDYWxsYmFjayk7XG4gICAgICB9KTtcbiAgICB9KSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgfSk7XG4gIH0sXG5cbiAgX3NldF9jbGllbnQoY2xpZW50KSB7XG4gICAgY29uc3QgZGVmaW5lQ29ubmVjdGlvbk9wdGlvbnMgPSBfLmNsb25lRGVlcCh0aGlzLl9jb25uZWN0aW9uKTtcblxuICAgIHRoaXMuX2NsaWVudCA9IGNsaWVudDtcbiAgICB0aGlzLl9kZWZpbmVfY29ubmVjdGlvbiA9IG5ldyBjcWwuQ2xpZW50KGRlZmluZUNvbm5lY3Rpb25PcHRpb25zKTtcblxuICAgIC8vIFJlc2V0IGNvbm5lY3Rpb25zIG9uIGFsbCBtb2RlbHNcbiAgICBPYmplY3Qua2V5cyh0aGlzLl9tb2RlbHMpLmZvckVhY2goKGkpID0+IHtcbiAgICAgIHRoaXMuX21vZGVsc1tpXS5fcHJvcGVydGllcy5jcWwgPSB0aGlzLl9jbGllbnQ7XG4gICAgICB0aGlzLl9tb2RlbHNbaV0uX3Byb3BlcnRpZXMuZGVmaW5lX2Nvbm5lY3Rpb24gPSB0aGlzLl9kZWZpbmVfY29ubmVjdGlvbjtcbiAgICB9KTtcbiAgfSxcblxuICBpbml0KGNhbGxiYWNrKSB7XG4gICAgY29uc3Qgb25Vc2VyRGVmaW5lZEFnZ3JlZ2F0ZXMgPSAoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbWFuYWdlbWVudFRhc2tzID0gW107XG4gICAgICBpZiAodGhpcy5fa2V5c3BhY2UgJiYgdGhpcy5fb3B0aW9ucy5tYW5hZ2VFU0luZGV4KSB7XG4gICAgICAgIHRoaXMuYXNzZXJ0RVNJbmRleEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkodGhpcy5fYXNzZXJ0X2VzX2luZGV4KTtcbiAgICAgICAgbWFuYWdlbWVudFRhc2tzLnB1c2godGhpcy5hc3NlcnRFU0luZGV4QXN5bmMoKSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fa2V5c3BhY2UgJiYgdGhpcy5fb3B0aW9ucy5tYW5hZ2VHcmFwaHMpIHtcbiAgICAgICAgdGhpcy5hc3NlcnRHcmVtbGluR3JhcGhBc3luYyA9IFByb21pc2UucHJvbWlzaWZ5KHRoaXMuX2Fzc2VydF9ncmVtbGluX2dyYXBoKTtcbiAgICAgICAgbWFuYWdlbWVudFRhc2tzLnB1c2godGhpcy5hc3NlcnRHcmVtbGluR3JhcGhBc3luYygpKTtcbiAgICAgIH1cbiAgICAgIFByb21pc2UuYWxsKG1hbmFnZW1lbnRUYXNrcylcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRoaXMpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycjEpID0+IHtcbiAgICAgICAgICBjYWxsYmFjayhlcnIxKTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uVXNlckRlZmluZWRGdW5jdGlvbnMgPSBmdW5jdGlvbiBmKGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLl9hc3NlcnRfdXNlcl9kZWZpbmVkX2FnZ3JlZ2F0ZXMob25Vc2VyRGVmaW5lZEFnZ3JlZ2F0ZXMuYmluZCh0aGlzKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IChidWlsZEVycm9yKCdtb2RlbC52YWxpZGF0b3IuaW52YWxpZHVkYScsIGUubWVzc2FnZSkpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBvblVzZXJEZWZpbmVkVHlwZXMgPSBmdW5jdGlvbiBmKGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLl9hc3NlcnRfdXNlcl9kZWZpbmVkX2Z1bmN0aW9ucyhvblVzZXJEZWZpbmVkRnVuY3Rpb25zLmJpbmQodGhpcykpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyAoYnVpbGRFcnJvcignbW9kZWwudmFsaWRhdG9yLmludmFsaWR1ZGYnLCBlLm1lc3NhZ2UpKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb25LZXlzcGFjZSA9IGZ1bmN0aW9uIGYoZXJyKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuX3NldF9jbGllbnQobmV3IGNxbC5DbGllbnQodGhpcy5fY29ubmVjdGlvbikpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5fYXNzZXJ0X3VzZXJfZGVmaW5lZF90eXBlcyhvblVzZXJEZWZpbmVkVHlwZXMuYmluZCh0aGlzKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IChidWlsZEVycm9yKCdtb2RlbC52YWxpZGF0b3IuaW52YWxpZHVkdCcsIGUubWVzc2FnZSkpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBpZiAodGhpcy5fa2V5c3BhY2UgJiYgdGhpcy5fb3B0aW9ucy5jcmVhdGVLZXlzcGFjZSAhPT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuX2Fzc2VydF9rZXlzcGFjZShvbktleXNwYWNlLmJpbmQodGhpcykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvbktleXNwYWNlLmNhbGwodGhpcyk7XG4gICAgfVxuICB9LFxuXG4gIGFkZE1vZGVsKG1vZGVsTmFtZSwgbW9kZWxTY2hlbWEpIHtcbiAgICBpZiAoIW1vZGVsTmFtZSB8fCB0eXBlb2YgKG1vZGVsTmFtZSkgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyAoYnVpbGRFcnJvcignbW9kZWwudmFsaWRhdG9yLmludmFsaWRzY2hlbWEnLCAnTW9kZWwgbmFtZSBtdXN0IGJlIGEgdmFsaWQgc3RyaW5nJykpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBzY2hlbWVyLnZhbGlkYXRlX21vZGVsX3NjaGVtYShtb2RlbFNjaGVtYSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgKGJ1aWxkRXJyb3IoJ21vZGVsLnZhbGlkYXRvci5pbnZhbGlkc2NoZW1hJywgZS5tZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLm9wdGlvbnMgJiYgbW9kZWxTY2hlbWEub3B0aW9ucy50aW1lc3RhbXBzKSB7XG4gICAgICBjb25zdCB0aW1lc3RhbXBPcHRpb25zID0ge1xuICAgICAgICBjcmVhdGVkQXQ6IG1vZGVsU2NoZW1hLm9wdGlvbnMudGltZXN0YW1wcy5jcmVhdGVkQXQgfHwgJ2NyZWF0ZWRBdCcsXG4gICAgICAgIHVwZGF0ZWRBdDogbW9kZWxTY2hlbWEub3B0aW9ucy50aW1lc3RhbXBzLnVwZGF0ZWRBdCB8fCAndXBkYXRlZEF0JyxcbiAgICAgIH07XG4gICAgICBtb2RlbFNjaGVtYS5vcHRpb25zLnRpbWVzdGFtcHMgPSB0aW1lc3RhbXBPcHRpb25zO1xuXG4gICAgICBtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEub3B0aW9ucy50aW1lc3RhbXBzLmNyZWF0ZWRBdF0gPSB7XG4gICAgICAgIHR5cGU6ICd0aW1lc3RhbXAnLFxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgJGRiX2Z1bmN0aW9uOiAndG9UaW1lc3RhbXAobm93KCkpJyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEub3B0aW9ucy50aW1lc3RhbXBzLnVwZGF0ZWRBdF0gPSB7XG4gICAgICAgIHR5cGU6ICd0aW1lc3RhbXAnLFxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgJGRiX2Z1bmN0aW9uOiAndG9UaW1lc3RhbXAobm93KCkpJyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLm9wdGlvbnMgJiYgbW9kZWxTY2hlbWEub3B0aW9ucy52ZXJzaW9ucykge1xuICAgICAgY29uc3QgdmVyc2lvbk9wdGlvbnMgPSB7XG4gICAgICAgIGtleTogbW9kZWxTY2hlbWEub3B0aW9ucy52ZXJzaW9ucy5rZXkgfHwgJ19fdicsXG4gICAgICB9O1xuICAgICAgbW9kZWxTY2hlbWEub3B0aW9ucy52ZXJzaW9ucyA9IHZlcnNpb25PcHRpb25zO1xuXG4gICAgICBtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEub3B0aW9ucy52ZXJzaW9ucy5rZXldID0ge1xuICAgICAgICB0eXBlOiAndGltZXV1aWQnLFxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgJGRiX2Z1bmN0aW9uOiAnbm93KCknLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBiYXNlUHJvcGVydGllcyA9IHtcbiAgICAgIG5hbWU6IG1vZGVsTmFtZSxcbiAgICAgIHNjaGVtYTogbW9kZWxTY2hlbWEsXG4gICAgICBrZXlzcGFjZTogdGhpcy5fa2V5c3BhY2UsXG4gICAgICBkZWZpbmVfY29ubmVjdGlvbjogdGhpcy5fZGVmaW5lX2Nvbm5lY3Rpb24sXG4gICAgICBjcWw6IHRoaXMuX2NsaWVudCxcbiAgICAgIGVzY2xpZW50OiB0aGlzLl9lc2NsaWVudCxcbiAgICAgIGdyZW1saW5fY2xpZW50OiB0aGlzLl9ncmVtbGluX2NsaWVudCxcbiAgICAgIGdldF9jb25zdHJ1Y3RvcjogdGhpcy5nZXRNb2RlbC5iaW5kKHRoaXMsIG1vZGVsTmFtZSksXG4gICAgICBpbml0OiB0aGlzLmluaXQuYmluZCh0aGlzKSxcbiAgICAgIGRyb3BUYWJsZU9uU2NoZW1hQ2hhbmdlOiB0aGlzLl9vcHRpb25zLmRyb3BUYWJsZU9uU2NoZW1hQ2hhbmdlLFxuICAgICAgY3JlYXRlVGFibGU6IHRoaXMuX29wdGlvbnMuY3JlYXRlVGFibGUsXG4gICAgICBtaWdyYXRpb246IHRoaXMuX29wdGlvbnMubWlncmF0aW9uLFxuICAgICAgZGlzYWJsZVRUWUNvbmZpcm1hdGlvbjogdGhpcy5fb3B0aW9ucy5kaXNhYmxlVFRZQ29uZmlybWF0aW9uLFxuICAgIH07XG5cbiAgICB0aGlzLl9tb2RlbHNbbW9kZWxOYW1lXSA9IHRoaXMuX2dlbmVyYXRlX21vZGVsKGJhc2VQcm9wZXJ0aWVzKTtcbiAgICByZXR1cm4gdGhpcy5fbW9kZWxzW21vZGVsTmFtZV07XG4gIH0sXG5cbiAgZ2V0TW9kZWwobW9kZWxOYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vZGVsc1ttb2RlbE5hbWVdIHx8IG51bGw7XG4gIH0sXG5cbiAgY2xvc2UoY2FsbGJhY2spIHtcbiAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IG5vb3A7XG5cbiAgICBpZiAodGhpcy5vcm0uX2VzY2xpZW50KSB7XG4gICAgICB0aGlzLm9ybS5fZXNjbGllbnQuY2xvc2UoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcm0uX2dyZW1saW5fY2xpZW50ICYmIHRoaXMub3JtLl9ncmVtbGluX2NsaWVudC5jb25uZWN0aW9uICYmIHRoaXMub3JtLl9ncmVtbGluX2NsaWVudC5jb25uZWN0aW9uLndzKSB7XG4gICAgICB0aGlzLm9ybS5fZ3JlbWxpbl9jbGllbnQuY29ubmVjdGlvbi53cy5jbG9zZSgpO1xuICAgIH1cblxuICAgIGNvbnN0IGNsaWVudHNUb1NodXRkb3duID0gW107XG4gICAgaWYgKHRoaXMub3JtLl9jbGllbnQpIHtcbiAgICAgIGNsaWVudHNUb1NodXRkb3duLnB1c2godGhpcy5vcm0uX2NsaWVudC5zaHV0ZG93bigpKTtcbiAgICB9XG4gICAgaWYgKHRoaXMub3JtLl9kZWZpbmVfY29ubmVjdGlvbikge1xuICAgICAgY2xpZW50c1RvU2h1dGRvd24ucHVzaCh0aGlzLm9ybS5fZGVmaW5lX2Nvbm5lY3Rpb24uc2h1dGRvd24oKSk7XG4gICAgfVxuXG4gICAgUHJvbWlzZS5hbGwoY2xpZW50c1RvU2h1dGRvd24pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgIH0pO1xuICB9LFxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBBcG9sbG87XG4iXX0=