'use strict';

var _ = require('lodash');
var util = require('util');

var arraySort = function arraySort(a, b) {
  if (a > b) return 1;
  if (a < b) return -1;
  return 0;
};

var normalizeTypeDef = function normalizeTypeDef(typeDef) {
  return typeDef.replace(/[\s]/g, '').replace(/varchar/g, 'text').replace(/frozen/ig, 'frozen');
};

var normalizer = {
  normalize_replication_option(replicationOptions) {
    var normalizedReplicationOptions = replicationOptions;
    Object.keys(normalizedReplicationOptions).forEach(function (key) {
      if (key === 'class') {
        normalizedReplicationOptions[key] = normalizedReplicationOptions[key].replace('org.apache.cassandra.locator.', '');
        return;
      }
      normalizedReplicationOptions[key] = parseInt(normalizedReplicationOptions[key], 10);
    });
    return normalizedReplicationOptions;
  },

  normalize_user_defined_type(fieldType) {
    var normalizedFieldType = normalizeTypeDef(fieldType);
    if (normalizedFieldType.includes('<') && !normalizedFieldType.startsWith('frozen<')) {
      normalizedFieldType = util.format('frozen<%s>', normalizedFieldType);
    }
    return normalizedFieldType;
  },

  normalize_primary_key(outputSchema) {
    if (outputSchema.key && typeof outputSchema.key[0] === 'string') {
      outputSchema.key[0] = [outputSchema.key[0]];
    }

    if (outputSchema.key && outputSchema.key.length) {
      for (var i = 1; i < outputSchema.key.length; i++) {
        if (!outputSchema.clustering_order) outputSchema.clustering_order = {};
        if (!outputSchema.clustering_order[outputSchema.key[i]]) {
          outputSchema.clustering_order[outputSchema.key[i]] = 'ASC';
        }

        // eslint-disable-next-line max-len
        outputSchema.clustering_order[outputSchema.key[i]] = outputSchema.clustering_order[outputSchema.key[i]].toUpperCase();
      }
    }
  },

  normalize_fields(modelSchema, outputSchema) {
    Object.keys(outputSchema.fields).forEach(function (fieldName) {
      if (typeof outputSchema.fields[fieldName] === 'string') {
        outputSchema.fields[fieldName] = { type: outputSchema.fields[fieldName] };
      }

      if (fieldName === 'solr_query' || outputSchema.fields[fieldName].virtual) {
        delete outputSchema.fields[fieldName];
        return;
      }

      if (outputSchema.fields[fieldName].typeDef) {
        outputSchema.fields[fieldName] = {
          type: outputSchema.fields[fieldName].type,
          typeDef: outputSchema.fields[fieldName].typeDef
        };
      } else {
        outputSchema.fields[fieldName] = { type: outputSchema.fields[fieldName].type };
      }

      if (outputSchema.fields[fieldName].type === 'varchar') {
        outputSchema.fields[fieldName].type = 'text';
      }

      if (['map', 'list', 'set', 'frozen'].includes(outputSchema.fields[fieldName].type)) {
        if (modelSchema.typeMaps && modelSchema.typeMaps[fieldName]) {
          outputSchema.fields[fieldName].typeDef = modelSchema.typeMaps[fieldName];
        } else {
          outputSchema.fields[fieldName].typeDef = normalizeTypeDef(outputSchema.fields[fieldName].typeDef);
        }
      }

      if (modelSchema.staticMaps && modelSchema.staticMaps[fieldName] === true) {
        outputSchema.fields[fieldName].static = true;
      } else if (modelSchema.fields[fieldName].static) {
        outputSchema.fields[fieldName].static = true;
      }
    });
  },

  normalize_materialized_views(outputSchema) {
    if (!outputSchema.materialized_views) {
      outputSchema.materialized_views = {};
    }

    Object.keys(outputSchema.materialized_views).forEach(function (materializedViewName) {
      var outputMView = outputSchema.materialized_views[materializedViewName];
      // make parition key an array
      if (outputMView.key && typeof outputMView.key[0] === 'string') {
        outputMView.key[0] = [outputMView.key[0]];
      }

      // add clustering_order for all clustering keys
      if (outputMView.key && outputMView.key.length) {
        for (var i = 1; i < outputMView.key.length; i++) {
          if (!outputMView.clustering_order) {
            outputMView.clustering_order = {};
          }
          if (!outputMView.clustering_order[outputMView.key[i]]) {
            outputMView.clustering_order[outputMView.key[i]] = 'ASC';
          }
          // eslint-disable-next-line max-len
          outputMView.clustering_order[outputMView.key[i]] = outputMView.clustering_order[outputMView.key[i]].toUpperCase();
        }
      }

      // add all non existent primary key items to select and sort them
      for (var pkeyIndex = 0; pkeyIndex < outputMView.key.length; pkeyIndex++) {
        if (pkeyIndex === 0) {
          for (var partitionIndex = 0; partitionIndex < outputMView.key[pkeyIndex].length; partitionIndex++) {
            if (!outputMView.select.includes(outputMView.key[pkeyIndex][partitionIndex])) {
              outputMView.select.push(outputMView.key[pkeyIndex][partitionIndex]);
            }
          }
        } else if (!outputMView.select.includes(outputMView.key[pkeyIndex])) {
          outputMView.select.push(outputMView.key[pkeyIndex]);
        }
      }

      // check if select has * and then add all fields to select
      if (outputMView.select[0] === '*') {
        outputMView.select = Object.keys(outputSchema.fields);
      }

      outputMView.select.sort(arraySort);
    });
  },

  normalize_indexes(outputSchema) {
    if (!outputSchema.indexes) {
      outputSchema.indexes = [];
    }
    for (var i = 0; i < outputSchema.indexes.length; i++) {
      var indexNameList = outputSchema.indexes[i].replace(/["\s]/g, '').split(/[()]/g);
      if (indexNameList.length > 1) {
        indexNameList[0] = indexNameList[0].toLowerCase();
        if (indexNameList[0] === 'values') outputSchema.indexes[i] = indexNameList[1];else outputSchema.indexes[i] = util.format('%s(%s)', indexNameList[0], indexNameList[1]);
      } else {
        outputSchema.indexes[i] = indexNameList[0];
      }
    }
    outputSchema.indexes.sort(arraySort);
  },

  normalize_custom_indexes(outputSchema) {
    if (outputSchema.custom_index) {
      outputSchema.custom_indexes = [outputSchema.custom_index];
      delete outputSchema.custom_index;
    }

    if (outputSchema.custom_indexes) {
      var customArraySort = function customArraySort(a, b) {
        if (a.on > b.on) return 1;
        if (a.on < b.on) return -1;

        if (a.using > b.using) return 1;
        if (a.using < b.using) return -1;

        if (a.options > b.options) return 1;
        if (a.options < b.options) return -1;

        return 0;
      };

      outputSchema.custom_indexes.sort(customArraySort);
    } else {
      outputSchema.custom_indexes = [];
    }

    outputSchema.custom_indexes = _.remove(outputSchema.custom_indexes, function (cindex) {
      return cindex.on !== 'solr_query';
    });
  },

  normalize_model_schema(modelSchema) {
    var outputSchema = _.cloneDeep(modelSchema, true);
    var normalizableSchemaProperties = ['fields', 'key', 'clustering_order', 'materialized_views', 'indexes', 'custom_index', 'custom_indexes'];

    Object.keys(outputSchema).forEach(function (schemaProperty) {
      if (!normalizableSchemaProperties.includes(schemaProperty)) {
        delete outputSchema[schemaProperty];
      }
    });

    this.normalize_fields(modelSchema, outputSchema);
    this.normalize_primary_key(outputSchema);
    this.normalize_materialized_views(outputSchema);
    this.normalize_indexes(outputSchema);
    this.normalize_custom_indexes(outputSchema);

    return outputSchema;
  },

  remove_dependent_views_from_normalized_schema(normalizedDBSchema, dbSchema, fieldName) {
    var dependentViews = [];
    Object.keys(normalizedDBSchema.materialized_views).forEach(function (dbViewName) {
      if (normalizedDBSchema.materialized_views[dbViewName].select.includes(fieldName)) {
        dependentViews.push(dbViewName);
      } else if (normalizedDBSchema.materialized_views[dbViewName].select[0] === '*') {
        dependentViews.push(dbViewName);
      } else if (normalizedDBSchema.materialized_views[dbViewName].key.includes(fieldName)) {
        dependentViews.push(dbViewName);
      } else if (_.isArray(normalizedDBSchema.materialized_views[dbViewName].key[0]) && normalizedDBSchema.materialized_views[dbViewName].key[0].includes(fieldName)) {
        dependentViews.push(dbViewName);
      }
    });
    dependentViews.forEach(function (viewName) {
      normalizedDBSchema.materialized_views[viewName] = {};
    });
  }
};

module.exports = normalizer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9ub3JtYWxpemVyLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwidXRpbCIsImFycmF5U29ydCIsImEiLCJiIiwibm9ybWFsaXplVHlwZURlZiIsInR5cGVEZWYiLCJyZXBsYWNlIiwibm9ybWFsaXplciIsIm5vcm1hbGl6ZV9yZXBsaWNhdGlvbl9vcHRpb24iLCJyZXBsaWNhdGlvbk9wdGlvbnMiLCJub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJwYXJzZUludCIsIm5vcm1hbGl6ZV91c2VyX2RlZmluZWRfdHlwZSIsImZpZWxkVHlwZSIsIm5vcm1hbGl6ZWRGaWVsZFR5cGUiLCJpbmNsdWRlcyIsInN0YXJ0c1dpdGgiLCJmb3JtYXQiLCJub3JtYWxpemVfcHJpbWFyeV9rZXkiLCJvdXRwdXRTY2hlbWEiLCJsZW5ndGgiLCJpIiwiY2x1c3RlcmluZ19vcmRlciIsInRvVXBwZXJDYXNlIiwibm9ybWFsaXplX2ZpZWxkcyIsIm1vZGVsU2NoZW1hIiwiZmllbGRzIiwiZmllbGROYW1lIiwidHlwZSIsInZpcnR1YWwiLCJ0eXBlTWFwcyIsInN0YXRpY01hcHMiLCJzdGF0aWMiLCJub3JtYWxpemVfbWF0ZXJpYWxpemVkX3ZpZXdzIiwibWF0ZXJpYWxpemVkX3ZpZXdzIiwibWF0ZXJpYWxpemVkVmlld05hbWUiLCJvdXRwdXRNVmlldyIsInBrZXlJbmRleCIsInBhcnRpdGlvbkluZGV4Iiwic2VsZWN0IiwicHVzaCIsInNvcnQiLCJub3JtYWxpemVfaW5kZXhlcyIsImluZGV4ZXMiLCJpbmRleE5hbWVMaXN0Iiwic3BsaXQiLCJ0b0xvd2VyQ2FzZSIsIm5vcm1hbGl6ZV9jdXN0b21faW5kZXhlcyIsImN1c3RvbV9pbmRleCIsImN1c3RvbV9pbmRleGVzIiwiY3VzdG9tQXJyYXlTb3J0Iiwib24iLCJ1c2luZyIsIm9wdGlvbnMiLCJyZW1vdmUiLCJjaW5kZXgiLCJub3JtYWxpemVfbW9kZWxfc2NoZW1hIiwiY2xvbmVEZWVwIiwibm9ybWFsaXphYmxlU2NoZW1hUHJvcGVydGllcyIsInNjaGVtYVByb3BlcnR5IiwicmVtb3ZlX2RlcGVuZGVudF92aWV3c19mcm9tX25vcm1hbGl6ZWRfc2NoZW1hIiwibm9ybWFsaXplZERCU2NoZW1hIiwiZGJTY2hlbWEiLCJkZXBlbmRlbnRWaWV3cyIsImRiVmlld05hbWUiLCJpc0FycmF5Iiwidmlld05hbWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLElBQUlDLFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUMsT0FBT0QsUUFBUSxNQUFSLENBQWI7O0FBRUEsSUFBTUUsWUFBWSxTQUFaQSxTQUFZLENBQUNDLENBQUQsRUFBSUMsQ0FBSixFQUFVO0FBQzFCLE1BQUlELElBQUlDLENBQVIsRUFBVyxPQUFPLENBQVA7QUFDWCxNQUFJRCxJQUFJQyxDQUFSLEVBQVcsT0FBTyxDQUFDLENBQVI7QUFDWCxTQUFPLENBQVA7QUFDRCxDQUpEOztBQU1BLElBQU1DLG1CQUFtQixTQUFuQkEsZ0JBQW1CLENBQUNDLE9BQUQ7QUFBQSxTQUFhQSxRQUFRQyxPQUFSLENBQWdCLE9BQWhCLEVBQXlCLEVBQXpCLEVBQTZCQSxPQUE3QixDQUFxQyxVQUFyQyxFQUFpRCxNQUFqRCxFQUF5REEsT0FBekQsQ0FBaUUsVUFBakUsRUFBNkUsUUFBN0UsQ0FBYjtBQUFBLENBQXpCOztBQUVBLElBQU1DLGFBQWE7QUFDakJDLCtCQUE2QkMsa0JBQTdCLEVBQWlEO0FBQy9DLFFBQU1DLCtCQUErQkQsa0JBQXJDO0FBQ0FFLFdBQU9DLElBQVAsQ0FBWUYsNEJBQVosRUFBMENHLE9BQTFDLENBQWtELFVBQUNDLEdBQUQsRUFBUztBQUN6RCxVQUFJQSxRQUFRLE9BQVosRUFBcUI7QUFDbkJKLHFDQUE2QkksR0FBN0IsSUFBb0NKLDZCQUE2QkksR0FBN0IsRUFBa0NSLE9BQWxDLENBQTBDLCtCQUExQyxFQUEyRSxFQUEzRSxDQUFwQztBQUNBO0FBQ0Q7QUFDREksbUNBQTZCSSxHQUE3QixJQUFvQ0MsU0FBU0wsNkJBQTZCSSxHQUE3QixDQUFULEVBQTRDLEVBQTVDLENBQXBDO0FBQ0QsS0FORDtBQU9BLFdBQU9KLDRCQUFQO0FBQ0QsR0FYZ0I7O0FBYWpCTSw4QkFBNEJDLFNBQTVCLEVBQXVDO0FBQ3JDLFFBQUlDLHNCQUFzQmQsaUJBQWlCYSxTQUFqQixDQUExQjtBQUNBLFFBQUlDLG9CQUFvQkMsUUFBcEIsQ0FBNkIsR0FBN0IsS0FBcUMsQ0FBQ0Qsb0JBQW9CRSxVQUFwQixDQUErQixTQUEvQixDQUExQyxFQUFxRjtBQUNuRkYsNEJBQXNCbEIsS0FBS3FCLE1BQUwsQ0FBWSxZQUFaLEVBQTBCSCxtQkFBMUIsQ0FBdEI7QUFDRDtBQUNELFdBQU9BLG1CQUFQO0FBQ0QsR0FuQmdCOztBQXFCakJJLHdCQUFzQkMsWUFBdEIsRUFBb0M7QUFDbEMsUUFBSUEsYUFBYVQsR0FBYixJQUFvQixPQUFPUyxhQUFhVCxHQUFiLENBQWlCLENBQWpCLENBQVAsS0FBK0IsUUFBdkQsRUFBaUU7QUFDL0RTLG1CQUFhVCxHQUFiLENBQWlCLENBQWpCLElBQXNCLENBQUNTLGFBQWFULEdBQWIsQ0FBaUIsQ0FBakIsQ0FBRCxDQUF0QjtBQUNEOztBQUVELFFBQUlTLGFBQWFULEdBQWIsSUFBb0JTLGFBQWFULEdBQWIsQ0FBaUJVLE1BQXpDLEVBQWlEO0FBQy9DLFdBQUssSUFBSUMsSUFBSSxDQUFiLEVBQWdCQSxJQUFJRixhQUFhVCxHQUFiLENBQWlCVSxNQUFyQyxFQUE2Q0MsR0FBN0MsRUFBa0Q7QUFDaEQsWUFBSSxDQUFDRixhQUFhRyxnQkFBbEIsRUFBb0NILGFBQWFHLGdCQUFiLEdBQWdDLEVBQWhDO0FBQ3BDLFlBQUksQ0FBQ0gsYUFBYUcsZ0JBQWIsQ0FBOEJILGFBQWFULEdBQWIsQ0FBaUJXLENBQWpCLENBQTlCLENBQUwsRUFBeUQ7QUFDdkRGLHVCQUFhRyxnQkFBYixDQUE4QkgsYUFBYVQsR0FBYixDQUFpQlcsQ0FBakIsQ0FBOUIsSUFBcUQsS0FBckQ7QUFDRDs7QUFFRDtBQUNBRixxQkFBYUcsZ0JBQWIsQ0FBOEJILGFBQWFULEdBQWIsQ0FBaUJXLENBQWpCLENBQTlCLElBQXFERixhQUFhRyxnQkFBYixDQUE4QkgsYUFBYVQsR0FBYixDQUFpQlcsQ0FBakIsQ0FBOUIsRUFBbURFLFdBQW5ELEVBQXJEO0FBQ0Q7QUFDRjtBQUNGLEdBckNnQjs7QUF1Q2pCQyxtQkFBaUJDLFdBQWpCLEVBQThCTixZQUE5QixFQUE0QztBQUMxQ1osV0FBT0MsSUFBUCxDQUFZVyxhQUFhTyxNQUF6QixFQUFpQ2pCLE9BQWpDLENBQXlDLFVBQUNrQixTQUFELEVBQWU7QUFDdEQsVUFBSSxPQUFRUixhQUFhTyxNQUFiLENBQW9CQyxTQUFwQixDQUFSLEtBQTRDLFFBQWhELEVBQTBEO0FBQ3hEUixxQkFBYU8sTUFBYixDQUFvQkMsU0FBcEIsSUFBaUMsRUFBRUMsTUFBTVQsYUFBYU8sTUFBYixDQUFvQkMsU0FBcEIsQ0FBUixFQUFqQztBQUNEOztBQUVELFVBQUlBLGNBQWMsWUFBZCxJQUE4QlIsYUFBYU8sTUFBYixDQUFvQkMsU0FBcEIsRUFBK0JFLE9BQWpFLEVBQTBFO0FBQ3hFLGVBQU9WLGFBQWFPLE1BQWIsQ0FBb0JDLFNBQXBCLENBQVA7QUFDQTtBQUNEOztBQUVELFVBQUlSLGFBQWFPLE1BQWIsQ0FBb0JDLFNBQXBCLEVBQStCMUIsT0FBbkMsRUFBNEM7QUFDMUNrQixxQkFBYU8sTUFBYixDQUFvQkMsU0FBcEIsSUFBaUM7QUFDL0JDLGdCQUFNVCxhQUFhTyxNQUFiLENBQW9CQyxTQUFwQixFQUErQkMsSUFETjtBQUUvQjNCLG1CQUFTa0IsYUFBYU8sTUFBYixDQUFvQkMsU0FBcEIsRUFBK0IxQjtBQUZULFNBQWpDO0FBSUQsT0FMRCxNQUtPO0FBQ0xrQixxQkFBYU8sTUFBYixDQUFvQkMsU0FBcEIsSUFBaUMsRUFBRUMsTUFBTVQsYUFBYU8sTUFBYixDQUFvQkMsU0FBcEIsRUFBK0JDLElBQXZDLEVBQWpDO0FBQ0Q7O0FBRUQsVUFBSVQsYUFBYU8sTUFBYixDQUFvQkMsU0FBcEIsRUFBK0JDLElBQS9CLEtBQXdDLFNBQTVDLEVBQXVEO0FBQ3JEVCxxQkFBYU8sTUFBYixDQUFvQkMsU0FBcEIsRUFBK0JDLElBQS9CLEdBQXNDLE1BQXRDO0FBQ0Q7O0FBRUQsVUFBSSxDQUFDLEtBQUQsRUFBUSxNQUFSLEVBQWdCLEtBQWhCLEVBQXVCLFFBQXZCLEVBQWlDYixRQUFqQyxDQUEwQ0ksYUFBYU8sTUFBYixDQUFvQkMsU0FBcEIsRUFBK0JDLElBQXpFLENBQUosRUFBb0Y7QUFDbEYsWUFBSUgsWUFBWUssUUFBWixJQUF3QkwsWUFBWUssUUFBWixDQUFxQkgsU0FBckIsQ0FBNUIsRUFBNkQ7QUFDM0RSLHVCQUFhTyxNQUFiLENBQW9CQyxTQUFwQixFQUErQjFCLE9BQS9CLEdBQXlDd0IsWUFBWUssUUFBWixDQUFxQkgsU0FBckIsQ0FBekM7QUFDRCxTQUZELE1BRU87QUFDTFIsdUJBQWFPLE1BQWIsQ0FBb0JDLFNBQXBCLEVBQStCMUIsT0FBL0IsR0FBeUNELGlCQUFpQm1CLGFBQWFPLE1BQWIsQ0FBb0JDLFNBQXBCLEVBQStCMUIsT0FBaEQsQ0FBekM7QUFDRDtBQUNGOztBQUVELFVBQUl3QixZQUFZTSxVQUFaLElBQTBCTixZQUFZTSxVQUFaLENBQXVCSixTQUF2QixNQUFzQyxJQUFwRSxFQUEwRTtBQUN4RVIscUJBQWFPLE1BQWIsQ0FBb0JDLFNBQXBCLEVBQStCSyxNQUEvQixHQUF3QyxJQUF4QztBQUNELE9BRkQsTUFFTyxJQUFJUCxZQUFZQyxNQUFaLENBQW1CQyxTQUFuQixFQUE4QkssTUFBbEMsRUFBMEM7QUFDL0NiLHFCQUFhTyxNQUFiLENBQW9CQyxTQUFwQixFQUErQkssTUFBL0IsR0FBd0MsSUFBeEM7QUFDRDtBQUNGLEtBcENEO0FBcUNELEdBN0VnQjs7QUErRWpCQywrQkFBNkJkLFlBQTdCLEVBQTJDO0FBQ3pDLFFBQUksQ0FBQ0EsYUFBYWUsa0JBQWxCLEVBQXNDO0FBQ3BDZixtQkFBYWUsa0JBQWIsR0FBa0MsRUFBbEM7QUFDRDs7QUFFRDNCLFdBQU9DLElBQVAsQ0FBWVcsYUFBYWUsa0JBQXpCLEVBQTZDekIsT0FBN0MsQ0FBcUQsVUFBQzBCLG9CQUFELEVBQTBCO0FBQzdFLFVBQU1DLGNBQWNqQixhQUFhZSxrQkFBYixDQUFnQ0Msb0JBQWhDLENBQXBCO0FBQ0E7QUFDQSxVQUFJQyxZQUFZMUIsR0FBWixJQUFtQixPQUFPMEIsWUFBWTFCLEdBQVosQ0FBZ0IsQ0FBaEIsQ0FBUCxLQUE4QixRQUFyRCxFQUErRDtBQUM3RDBCLG9CQUFZMUIsR0FBWixDQUFnQixDQUFoQixJQUFxQixDQUFDMEIsWUFBWTFCLEdBQVosQ0FBZ0IsQ0FBaEIsQ0FBRCxDQUFyQjtBQUNEOztBQUVEO0FBQ0EsVUFBSTBCLFlBQVkxQixHQUFaLElBQW1CMEIsWUFBWTFCLEdBQVosQ0FBZ0JVLE1BQXZDLEVBQStDO0FBQzdDLGFBQUssSUFBSUMsSUFBSSxDQUFiLEVBQWdCQSxJQUFJZSxZQUFZMUIsR0FBWixDQUFnQlUsTUFBcEMsRUFBNENDLEdBQTVDLEVBQWlEO0FBQy9DLGNBQUksQ0FBQ2UsWUFBWWQsZ0JBQWpCLEVBQW1DO0FBQ2pDYyx3QkFBWWQsZ0JBQVosR0FBK0IsRUFBL0I7QUFDRDtBQUNELGNBQUksQ0FBQ2MsWUFBWWQsZ0JBQVosQ0FBNkJjLFlBQVkxQixHQUFaLENBQWdCVyxDQUFoQixDQUE3QixDQUFMLEVBQXVEO0FBQ3JEZSx3QkFBWWQsZ0JBQVosQ0FBNkJjLFlBQVkxQixHQUFaLENBQWdCVyxDQUFoQixDQUE3QixJQUFtRCxLQUFuRDtBQUNEO0FBQ0Q7QUFDQWUsc0JBQVlkLGdCQUFaLENBQTZCYyxZQUFZMUIsR0FBWixDQUFnQlcsQ0FBaEIsQ0FBN0IsSUFBbURlLFlBQVlkLGdCQUFaLENBQTZCYyxZQUFZMUIsR0FBWixDQUFnQlcsQ0FBaEIsQ0FBN0IsRUFBaURFLFdBQWpELEVBQW5EO0FBQ0Q7QUFDRjs7QUFFRDtBQUNBLFdBQUssSUFBSWMsWUFBWSxDQUFyQixFQUF3QkEsWUFBWUQsWUFBWTFCLEdBQVosQ0FBZ0JVLE1BQXBELEVBQTREaUIsV0FBNUQsRUFBeUU7QUFDdkUsWUFBSUEsY0FBYyxDQUFsQixFQUFxQjtBQUNuQixlQUFLLElBQUlDLGlCQUFpQixDQUExQixFQUE2QkEsaUJBQWlCRixZQUFZMUIsR0FBWixDQUFnQjJCLFNBQWhCLEVBQTJCakIsTUFBekUsRUFBaUZrQixnQkFBakYsRUFBbUc7QUFDakcsZ0JBQUksQ0FBQ0YsWUFBWUcsTUFBWixDQUFtQnhCLFFBQW5CLENBQTRCcUIsWUFBWTFCLEdBQVosQ0FBZ0IyQixTQUFoQixFQUEyQkMsY0FBM0IsQ0FBNUIsQ0FBTCxFQUE4RTtBQUM1RUYsMEJBQVlHLE1BQVosQ0FBbUJDLElBQW5CLENBQXdCSixZQUFZMUIsR0FBWixDQUFnQjJCLFNBQWhCLEVBQTJCQyxjQUEzQixDQUF4QjtBQUNEO0FBQ0Y7QUFDRixTQU5ELE1BTU8sSUFBSSxDQUFDRixZQUFZRyxNQUFaLENBQW1CeEIsUUFBbkIsQ0FBNEJxQixZQUFZMUIsR0FBWixDQUFnQjJCLFNBQWhCLENBQTVCLENBQUwsRUFBOEQ7QUFDbkVELHNCQUFZRyxNQUFaLENBQW1CQyxJQUFuQixDQUF3QkosWUFBWTFCLEdBQVosQ0FBZ0IyQixTQUFoQixDQUF4QjtBQUNEO0FBQ0Y7O0FBRUQ7QUFDQSxVQUFJRCxZQUFZRyxNQUFaLENBQW1CLENBQW5CLE1BQTBCLEdBQTlCLEVBQW1DO0FBQ2pDSCxvQkFBWUcsTUFBWixHQUFxQmhDLE9BQU9DLElBQVAsQ0FBWVcsYUFBYU8sTUFBekIsQ0FBckI7QUFDRDs7QUFFRFUsa0JBQVlHLE1BQVosQ0FBbUJFLElBQW5CLENBQXdCNUMsU0FBeEI7QUFDRCxLQXhDRDtBQXlDRCxHQTdIZ0I7O0FBK0hqQjZDLG9CQUFrQnZCLFlBQWxCLEVBQWdDO0FBQzlCLFFBQUksQ0FBQ0EsYUFBYXdCLE9BQWxCLEVBQTJCO0FBQ3pCeEIsbUJBQWF3QixPQUFiLEdBQXVCLEVBQXZCO0FBQ0Q7QUFDRCxTQUFLLElBQUl0QixJQUFJLENBQWIsRUFBZ0JBLElBQUlGLGFBQWF3QixPQUFiLENBQXFCdkIsTUFBekMsRUFBaURDLEdBQWpELEVBQXNEO0FBQ3BELFVBQU11QixnQkFBZ0J6QixhQUFhd0IsT0FBYixDQUFxQnRCLENBQXJCLEVBQXdCbkIsT0FBeEIsQ0FBZ0MsUUFBaEMsRUFBMEMsRUFBMUMsRUFBOEMyQyxLQUE5QyxDQUFvRCxPQUFwRCxDQUF0QjtBQUNBLFVBQUlELGNBQWN4QixNQUFkLEdBQXVCLENBQTNCLEVBQThCO0FBQzVCd0Isc0JBQWMsQ0FBZCxJQUFtQkEsY0FBYyxDQUFkLEVBQWlCRSxXQUFqQixFQUFuQjtBQUNBLFlBQUlGLGNBQWMsQ0FBZCxNQUFxQixRQUF6QixFQUFtQ3pCLGFBQWF3QixPQUFiLENBQXFCdEIsQ0FBckIsSUFBMEJ1QixjQUFjLENBQWQsQ0FBMUIsQ0FBbkMsS0FDS3pCLGFBQWF3QixPQUFiLENBQXFCdEIsQ0FBckIsSUFBMEJ6QixLQUFLcUIsTUFBTCxDQUFZLFFBQVosRUFBc0IyQixjQUFjLENBQWQsQ0FBdEIsRUFBd0NBLGNBQWMsQ0FBZCxDQUF4QyxDQUExQjtBQUNOLE9BSkQsTUFJTztBQUNMekIscUJBQWF3QixPQUFiLENBQXFCdEIsQ0FBckIsSUFBMEJ1QixjQUFjLENBQWQsQ0FBMUI7QUFDRDtBQUNGO0FBQ0R6QixpQkFBYXdCLE9BQWIsQ0FBcUJGLElBQXJCLENBQTBCNUMsU0FBMUI7QUFDRCxHQTlJZ0I7O0FBZ0pqQmtELDJCQUF5QjVCLFlBQXpCLEVBQXVDO0FBQ3JDLFFBQUlBLGFBQWE2QixZQUFqQixFQUErQjtBQUM3QjdCLG1CQUFhOEIsY0FBYixHQUE4QixDQUFDOUIsYUFBYTZCLFlBQWQsQ0FBOUI7QUFDQSxhQUFPN0IsYUFBYTZCLFlBQXBCO0FBQ0Q7O0FBRUQsUUFBSTdCLGFBQWE4QixjQUFqQixFQUFpQztBQUMvQixVQUFNQyxrQkFBa0IsU0FBbEJBLGVBQWtCLENBQUNwRCxDQUFELEVBQUlDLENBQUosRUFBVTtBQUNoQyxZQUFJRCxFQUFFcUQsRUFBRixHQUFPcEQsRUFBRW9ELEVBQWIsRUFBaUIsT0FBTyxDQUFQO0FBQ2pCLFlBQUlyRCxFQUFFcUQsRUFBRixHQUFPcEQsRUFBRW9ELEVBQWIsRUFBaUIsT0FBTyxDQUFDLENBQVI7O0FBRWpCLFlBQUlyRCxFQUFFc0QsS0FBRixHQUFVckQsRUFBRXFELEtBQWhCLEVBQXVCLE9BQU8sQ0FBUDtBQUN2QixZQUFJdEQsRUFBRXNELEtBQUYsR0FBVXJELEVBQUVxRCxLQUFoQixFQUF1QixPQUFPLENBQUMsQ0FBUjs7QUFFdkIsWUFBSXRELEVBQUV1RCxPQUFGLEdBQVl0RCxFQUFFc0QsT0FBbEIsRUFBMkIsT0FBTyxDQUFQO0FBQzNCLFlBQUl2RCxFQUFFdUQsT0FBRixHQUFZdEQsRUFBRXNELE9BQWxCLEVBQTJCLE9BQU8sQ0FBQyxDQUFSOztBQUUzQixlQUFPLENBQVA7QUFDRCxPQVhEOztBQWFBbEMsbUJBQWE4QixjQUFiLENBQTRCUixJQUE1QixDQUFpQ1MsZUFBakM7QUFDRCxLQWZELE1BZU87QUFDTC9CLG1CQUFhOEIsY0FBYixHQUE4QixFQUE5QjtBQUNEOztBQUVEOUIsaUJBQWE4QixjQUFiLEdBQThCdkQsRUFBRTRELE1BQUYsQ0FBU25DLGFBQWE4QixjQUF0QixFQUFzQyxVQUFDTSxNQUFEO0FBQUEsYUFBYUEsT0FBT0osRUFBUCxLQUFjLFlBQTNCO0FBQUEsS0FBdEMsQ0FBOUI7QUFDRCxHQTFLZ0I7O0FBNEtqQksseUJBQXVCL0IsV0FBdkIsRUFBb0M7QUFDbEMsUUFBTU4sZUFBZXpCLEVBQUUrRCxTQUFGLENBQVloQyxXQUFaLEVBQXlCLElBQXpCLENBQXJCO0FBQ0EsUUFBTWlDLCtCQUErQixDQUNuQyxRQURtQyxFQUN6QixLQUR5QixFQUNsQixrQkFEa0IsRUFDRSxvQkFERixFQUN3QixTQUR4QixFQUNtQyxjQURuQyxFQUNtRCxnQkFEbkQsQ0FBckM7O0FBSUFuRCxXQUFPQyxJQUFQLENBQVlXLFlBQVosRUFBMEJWLE9BQTFCLENBQWtDLFVBQUNrRCxjQUFELEVBQW9CO0FBQ3BELFVBQUksQ0FBQ0QsNkJBQTZCM0MsUUFBN0IsQ0FBc0M0QyxjQUF0QyxDQUFMLEVBQTREO0FBQzFELGVBQU94QyxhQUFhd0MsY0FBYixDQUFQO0FBQ0Q7QUFDRixLQUpEOztBQU1BLFNBQUtuQyxnQkFBTCxDQUFzQkMsV0FBdEIsRUFBbUNOLFlBQW5DO0FBQ0EsU0FBS0QscUJBQUwsQ0FBMkJDLFlBQTNCO0FBQ0EsU0FBS2MsNEJBQUwsQ0FBa0NkLFlBQWxDO0FBQ0EsU0FBS3VCLGlCQUFMLENBQXVCdkIsWUFBdkI7QUFDQSxTQUFLNEIsd0JBQUwsQ0FBOEI1QixZQUE5Qjs7QUFFQSxXQUFPQSxZQUFQO0FBQ0QsR0EvTGdCOztBQWlNakJ5QyxnREFBOENDLGtCQUE5QyxFQUFrRUMsUUFBbEUsRUFBNEVuQyxTQUE1RSxFQUF1RjtBQUNyRixRQUFNb0MsaUJBQWlCLEVBQXZCO0FBQ0F4RCxXQUFPQyxJQUFQLENBQVlxRCxtQkFBbUIzQixrQkFBL0IsRUFBbUR6QixPQUFuRCxDQUEyRCxVQUFDdUQsVUFBRCxFQUFnQjtBQUN6RSxVQUFJSCxtQkFBbUIzQixrQkFBbkIsQ0FBc0M4QixVQUF0QyxFQUFrRHpCLE1BQWxELENBQXlEeEIsUUFBekQsQ0FBa0VZLFNBQWxFLENBQUosRUFBa0Y7QUFDaEZvQyx1QkFBZXZCLElBQWYsQ0FBb0J3QixVQUFwQjtBQUNELE9BRkQsTUFFTyxJQUFJSCxtQkFBbUIzQixrQkFBbkIsQ0FBc0M4QixVQUF0QyxFQUFrRHpCLE1BQWxELENBQXlELENBQXpELE1BQWdFLEdBQXBFLEVBQXlFO0FBQzlFd0IsdUJBQWV2QixJQUFmLENBQW9Cd0IsVUFBcEI7QUFDRCxPQUZNLE1BRUEsSUFBSUgsbUJBQW1CM0Isa0JBQW5CLENBQXNDOEIsVUFBdEMsRUFBa0R0RCxHQUFsRCxDQUFzREssUUFBdEQsQ0FBK0RZLFNBQS9ELENBQUosRUFBK0U7QUFDcEZvQyx1QkFBZXZCLElBQWYsQ0FBb0J3QixVQUFwQjtBQUNELE9BRk0sTUFFQSxJQUFJdEUsRUFBRXVFLE9BQUYsQ0FBVUosbUJBQW1CM0Isa0JBQW5CLENBQXNDOEIsVUFBdEMsRUFBa0R0RCxHQUFsRCxDQUFzRCxDQUF0RCxDQUFWLEtBQ0ltRCxtQkFBbUIzQixrQkFBbkIsQ0FBc0M4QixVQUF0QyxFQUFrRHRELEdBQWxELENBQXNELENBQXRELEVBQXlESyxRQUF6RCxDQUFrRVksU0FBbEUsQ0FEUixFQUNzRjtBQUMzRm9DLHVCQUFldkIsSUFBZixDQUFvQndCLFVBQXBCO0FBQ0Q7QUFDRixLQVhEO0FBWUFELG1CQUFldEQsT0FBZixDQUF1QixVQUFDeUQsUUFBRCxFQUFjO0FBQ25DTCx5QkFBbUIzQixrQkFBbkIsQ0FBc0NnQyxRQUF0QyxJQUFrRCxFQUFsRDtBQUNELEtBRkQ7QUFHRDtBQWxOZ0IsQ0FBbkI7O0FBcU5BQyxPQUFPQyxPQUFQLEdBQWlCakUsVUFBakIiLCJmaWxlIjoibm9ybWFsaXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5cbmNvbnN0IGFycmF5U29ydCA9IChhLCBiKSA9PiB7XG4gIGlmIChhID4gYikgcmV0dXJuIDE7XG4gIGlmIChhIDwgYikgcmV0dXJuIC0xO1xuICByZXR1cm4gMDtcbn07XG5cbmNvbnN0IG5vcm1hbGl6ZVR5cGVEZWYgPSAodHlwZURlZikgPT4gdHlwZURlZi5yZXBsYWNlKC9bXFxzXS9nLCAnJykucmVwbGFjZSgvdmFyY2hhci9nLCAndGV4dCcpLnJlcGxhY2UoL2Zyb3plbi9pZywgJ2Zyb3plbicpO1xuXG5jb25zdCBub3JtYWxpemVyID0ge1xuICBub3JtYWxpemVfcmVwbGljYXRpb25fb3B0aW9uKHJlcGxpY2F0aW9uT3B0aW9ucykge1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnMgPSByZXBsaWNhdGlvbk9wdGlvbnM7XG4gICAgT2JqZWN0LmtleXMobm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9ucykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBpZiAoa2V5ID09PSAnY2xhc3MnKSB7XG4gICAgICAgIG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnNba2V5XSA9IG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnNba2V5XS5yZXBsYWNlKCdvcmcuYXBhY2hlLmNhc3NhbmRyYS5sb2NhdG9yLicsICcnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgbm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9uc1trZXldID0gcGFyc2VJbnQobm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9uc1trZXldLCAxMCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIG5vcm1hbGl6ZWRSZXBsaWNhdGlvbk9wdGlvbnM7XG4gIH0sXG5cbiAgbm9ybWFsaXplX3VzZXJfZGVmaW5lZF90eXBlKGZpZWxkVHlwZSkge1xuICAgIGxldCBub3JtYWxpemVkRmllbGRUeXBlID0gbm9ybWFsaXplVHlwZURlZihmaWVsZFR5cGUpO1xuICAgIGlmIChub3JtYWxpemVkRmllbGRUeXBlLmluY2x1ZGVzKCc8JykgJiYgIW5vcm1hbGl6ZWRGaWVsZFR5cGUuc3RhcnRzV2l0aCgnZnJvemVuPCcpKSB7XG4gICAgICBub3JtYWxpemVkRmllbGRUeXBlID0gdXRpbC5mb3JtYXQoJ2Zyb3plbjwlcz4nLCBub3JtYWxpemVkRmllbGRUeXBlKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vcm1hbGl6ZWRGaWVsZFR5cGU7XG4gIH0sXG5cbiAgbm9ybWFsaXplX3ByaW1hcnlfa2V5KG91dHB1dFNjaGVtYSkge1xuICAgIGlmIChvdXRwdXRTY2hlbWEua2V5ICYmIHR5cGVvZiBvdXRwdXRTY2hlbWEua2V5WzBdID09PSAnc3RyaW5nJykge1xuICAgICAgb3V0cHV0U2NoZW1hLmtleVswXSA9IFtvdXRwdXRTY2hlbWEua2V5WzBdXTtcbiAgICB9XG5cbiAgICBpZiAob3V0cHV0U2NoZW1hLmtleSAmJiBvdXRwdXRTY2hlbWEua2V5Lmxlbmd0aCkge1xuICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBvdXRwdXRTY2hlbWEua2V5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmICghb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXIpIG91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyID0ge307XG4gICAgICAgIGlmICghb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0U2NoZW1hLmtleVtpXV0pIHtcbiAgICAgICAgICBvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRTY2hlbWEua2V5W2ldXSA9ICdBU0MnO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgICAgb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0U2NoZW1hLmtleVtpXV0gPSBvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRTY2hlbWEua2V5W2ldXS50b1VwcGVyQ2FzZSgpO1xuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBub3JtYWxpemVfZmllbGRzKG1vZGVsU2NoZW1hLCBvdXRwdXRTY2hlbWEpIHtcbiAgICBPYmplY3Qua2V5cyhvdXRwdXRTY2hlbWEuZmllbGRzKS5mb3JFYWNoKChmaWVsZE5hbWUpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSkgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSA9IHsgdHlwZTogb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChmaWVsZE5hbWUgPT09ICdzb2xyX3F1ZXJ5JyB8fCBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udmlydHVhbCkge1xuICAgICAgICBkZWxldGUgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZURlZikge1xuICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0gPSB7XG4gICAgICAgICAgdHlwZTogb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUsXG4gICAgICAgICAgdHlwZURlZjogb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGVEZWYsXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0gPSB7IHR5cGU6IG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZSA9PT0gJ3ZhcmNoYXInKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlID0gJ3RleHQnO1xuICAgICAgfVxuXG4gICAgICBpZiAoWydtYXAnLCAnbGlzdCcsICdzZXQnLCAnZnJvemVuJ10uaW5jbHVkZXMob3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUpKSB7XG4gICAgICAgIGlmIChtb2RlbFNjaGVtYS50eXBlTWFwcyAmJiBtb2RlbFNjaGVtYS50eXBlTWFwc1tmaWVsZE5hbWVdKSB7XG4gICAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGVEZWYgPSBtb2RlbFNjaGVtYS50eXBlTWFwc1tmaWVsZE5hbWVdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlRGVmID0gbm9ybWFsaXplVHlwZURlZihvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZURlZik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG1vZGVsU2NoZW1hLnN0YXRpY01hcHMgJiYgbW9kZWxTY2hlbWEuc3RhdGljTWFwc1tmaWVsZE5hbWVdID09PSB0cnVlKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS5zdGF0aWMgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS5zdGF0aWMpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnN0YXRpYyA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgbm9ybWFsaXplX21hdGVyaWFsaXplZF92aWV3cyhvdXRwdXRTY2hlbWEpIHtcbiAgICBpZiAoIW91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpIHtcbiAgICAgIG91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MgPSB7fTtcbiAgICB9XG5cbiAgICBPYmplY3Qua2V5cyhvdXRwdXRTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzKS5mb3JFYWNoKChtYXRlcmlhbGl6ZWRWaWV3TmFtZSkgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0TVZpZXcgPSBvdXRwdXRTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW21hdGVyaWFsaXplZFZpZXdOYW1lXTtcbiAgICAgIC8vIG1ha2UgcGFyaXRpb24ga2V5IGFuIGFycmF5XG4gICAgICBpZiAob3V0cHV0TVZpZXcua2V5ICYmIHR5cGVvZiBvdXRwdXRNVmlldy5rZXlbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG91dHB1dE1WaWV3LmtleVswXSA9IFtvdXRwdXRNVmlldy5rZXlbMF1dO1xuICAgICAgfVxuXG4gICAgICAvLyBhZGQgY2x1c3RlcmluZ19vcmRlciBmb3IgYWxsIGNsdXN0ZXJpbmcga2V5c1xuICAgICAgaWYgKG91dHB1dE1WaWV3LmtleSAmJiBvdXRwdXRNVmlldy5rZXkubGVuZ3RoKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgb3V0cHV0TVZpZXcua2V5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKCFvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyKSB7XG4gICAgICAgICAgICBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyID0ge307XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghb3V0cHV0TVZpZXcuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRNVmlldy5rZXlbaV1dKSB7XG4gICAgICAgICAgICBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0gPSAnQVNDJztcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgICAgICBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0gPSBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0udG9VcHBlckNhc2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBhZGQgYWxsIG5vbiBleGlzdGVudCBwcmltYXJ5IGtleSBpdGVtcyB0byBzZWxlY3QgYW5kIHNvcnQgdGhlbVxuICAgICAgZm9yIChsZXQgcGtleUluZGV4ID0gMDsgcGtleUluZGV4IDwgb3V0cHV0TVZpZXcua2V5Lmxlbmd0aDsgcGtleUluZGV4KyspIHtcbiAgICAgICAgaWYgKHBrZXlJbmRleCA9PT0gMCkge1xuICAgICAgICAgIGZvciAobGV0IHBhcnRpdGlvbkluZGV4ID0gMDsgcGFydGl0aW9uSW5kZXggPCBvdXRwdXRNVmlldy5rZXlbcGtleUluZGV4XS5sZW5ndGg7IHBhcnRpdGlvbkluZGV4KyspIHtcbiAgICAgICAgICAgIGlmICghb3V0cHV0TVZpZXcuc2VsZWN0LmluY2x1ZGVzKG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdW3BhcnRpdGlvbkluZGV4XSkpIHtcbiAgICAgICAgICAgICAgb3V0cHV0TVZpZXcuc2VsZWN0LnB1c2gob3V0cHV0TVZpZXcua2V5W3BrZXlJbmRleF1bcGFydGl0aW9uSW5kZXhdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoIW91dHB1dE1WaWV3LnNlbGVjdC5pbmNsdWRlcyhvdXRwdXRNVmlldy5rZXlbcGtleUluZGV4XSkpIHtcbiAgICAgICAgICBvdXRwdXRNVmlldy5zZWxlY3QucHVzaChvdXRwdXRNVmlldy5rZXlbcGtleUluZGV4XSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gY2hlY2sgaWYgc2VsZWN0IGhhcyAqIGFuZCB0aGVuIGFkZCBhbGwgZmllbGRzIHRvIHNlbGVjdFxuICAgICAgaWYgKG91dHB1dE1WaWV3LnNlbGVjdFswXSA9PT0gJyonKSB7XG4gICAgICAgIG91dHB1dE1WaWV3LnNlbGVjdCA9IE9iamVjdC5rZXlzKG91dHB1dFNjaGVtYS5maWVsZHMpO1xuICAgICAgfVxuXG4gICAgICBvdXRwdXRNVmlldy5zZWxlY3Quc29ydChhcnJheVNvcnQpO1xuICAgIH0pO1xuICB9LFxuXG4gIG5vcm1hbGl6ZV9pbmRleGVzKG91dHB1dFNjaGVtYSkge1xuICAgIGlmICghb3V0cHV0U2NoZW1hLmluZGV4ZXMpIHtcbiAgICAgIG91dHB1dFNjaGVtYS5pbmRleGVzID0gW107XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3V0cHV0U2NoZW1hLmluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGluZGV4TmFtZUxpc3QgPSBvdXRwdXRTY2hlbWEuaW5kZXhlc1tpXS5yZXBsYWNlKC9bXCJcXHNdL2csICcnKS5zcGxpdCgvWygpXS9nKTtcbiAgICAgIGlmIChpbmRleE5hbWVMaXN0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgaW5kZXhOYW1lTGlzdFswXSA9IGluZGV4TmFtZUxpc3RbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGluZGV4TmFtZUxpc3RbMF0gPT09ICd2YWx1ZXMnKSBvdXRwdXRTY2hlbWEuaW5kZXhlc1tpXSA9IGluZGV4TmFtZUxpc3RbMV07XG4gICAgICAgIGVsc2Ugb3V0cHV0U2NoZW1hLmluZGV4ZXNbaV0gPSB1dGlsLmZvcm1hdCgnJXMoJXMpJywgaW5kZXhOYW1lTGlzdFswXSwgaW5kZXhOYW1lTGlzdFsxXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXRTY2hlbWEuaW5kZXhlc1tpXSA9IGluZGV4TmFtZUxpc3RbMF07XG4gICAgICB9XG4gICAgfVxuICAgIG91dHB1dFNjaGVtYS5pbmRleGVzLnNvcnQoYXJyYXlTb3J0KTtcbiAgfSxcblxuICBub3JtYWxpemVfY3VzdG9tX2luZGV4ZXMob3V0cHV0U2NoZW1hKSB7XG4gICAgaWYgKG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXgpIHtcbiAgICAgIG91dHB1dFNjaGVtYS5jdXN0b21faW5kZXhlcyA9IFtvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4XTtcbiAgICAgIGRlbGV0ZSBvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4O1xuICAgIH1cblxuICAgIGlmIChvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMpIHtcbiAgICAgIGNvbnN0IGN1c3RvbUFycmF5U29ydCA9IChhLCBiKSA9PiB7XG4gICAgICAgIGlmIChhLm9uID4gYi5vbikgcmV0dXJuIDE7XG4gICAgICAgIGlmIChhLm9uIDwgYi5vbikgcmV0dXJuIC0xO1xuXG4gICAgICAgIGlmIChhLnVzaW5nID4gYi51c2luZykgcmV0dXJuIDE7XG4gICAgICAgIGlmIChhLnVzaW5nIDwgYi51c2luZykgcmV0dXJuIC0xO1xuXG4gICAgICAgIGlmIChhLm9wdGlvbnMgPiBiLm9wdGlvbnMpIHJldHVybiAxO1xuICAgICAgICBpZiAoYS5vcHRpb25zIDwgYi5vcHRpb25zKSByZXR1cm4gLTE7XG5cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9O1xuXG4gICAgICBvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMuc29ydChjdXN0b21BcnJheVNvcnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMgPSBbXTtcbiAgICB9XG5cbiAgICBvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMgPSBfLnJlbW92ZShvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMsIChjaW5kZXgpID0+IChjaW5kZXgub24gIT09ICdzb2xyX3F1ZXJ5JykpO1xuICB9LFxuXG4gIG5vcm1hbGl6ZV9tb2RlbF9zY2hlbWEobW9kZWxTY2hlbWEpIHtcbiAgICBjb25zdCBvdXRwdXRTY2hlbWEgPSBfLmNsb25lRGVlcChtb2RlbFNjaGVtYSwgdHJ1ZSk7XG4gICAgY29uc3Qgbm9ybWFsaXphYmxlU2NoZW1hUHJvcGVydGllcyA9IFtcbiAgICAgICdmaWVsZHMnLCAna2V5JywgJ2NsdXN0ZXJpbmdfb3JkZXInLCAnbWF0ZXJpYWxpemVkX3ZpZXdzJywgJ2luZGV4ZXMnLCAnY3VzdG9tX2luZGV4JywgJ2N1c3RvbV9pbmRleGVzJyxcbiAgICBdO1xuXG4gICAgT2JqZWN0LmtleXMob3V0cHV0U2NoZW1hKS5mb3JFYWNoKChzY2hlbWFQcm9wZXJ0eSkgPT4ge1xuICAgICAgaWYgKCFub3JtYWxpemFibGVTY2hlbWFQcm9wZXJ0aWVzLmluY2x1ZGVzKHNjaGVtYVByb3BlcnR5KSkge1xuICAgICAgICBkZWxldGUgb3V0cHV0U2NoZW1hW3NjaGVtYVByb3BlcnR5XTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMubm9ybWFsaXplX2ZpZWxkcyhtb2RlbFNjaGVtYSwgb3V0cHV0U2NoZW1hKTtcbiAgICB0aGlzLm5vcm1hbGl6ZV9wcmltYXJ5X2tleShvdXRwdXRTY2hlbWEpO1xuICAgIHRoaXMubm9ybWFsaXplX21hdGVyaWFsaXplZF92aWV3cyhvdXRwdXRTY2hlbWEpO1xuICAgIHRoaXMubm9ybWFsaXplX2luZGV4ZXMob3V0cHV0U2NoZW1hKTtcbiAgICB0aGlzLm5vcm1hbGl6ZV9jdXN0b21faW5kZXhlcyhvdXRwdXRTY2hlbWEpO1xuXG4gICAgcmV0dXJuIG91dHB1dFNjaGVtYTtcbiAgfSxcblxuICByZW1vdmVfZGVwZW5kZW50X3ZpZXdzX2Zyb21fbm9ybWFsaXplZF9zY2hlbWEobm9ybWFsaXplZERCU2NoZW1hLCBkYlNjaGVtYSwgZmllbGROYW1lKSB7XG4gICAgY29uc3QgZGVwZW5kZW50Vmlld3MgPSBbXTtcbiAgICBPYmplY3Qua2V5cyhub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzKS5mb3JFYWNoKChkYlZpZXdOYW1lKSA9PiB7XG4gICAgICBpZiAobm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1tkYlZpZXdOYW1lXS5zZWxlY3QuaW5jbHVkZXMoZmllbGROYW1lKSkge1xuICAgICAgICBkZXBlbmRlbnRWaWV3cy5wdXNoKGRiVmlld05hbWUpO1xuICAgICAgfSBlbHNlIGlmIChub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW2RiVmlld05hbWVdLnNlbGVjdFswXSA9PT0gJyonKSB7XG4gICAgICAgIGRlcGVuZGVudFZpZXdzLnB1c2goZGJWaWV3TmFtZSk7XG4gICAgICB9IGVsc2UgaWYgKG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbZGJWaWV3TmFtZV0ua2V5LmluY2x1ZGVzKGZpZWxkTmFtZSkpIHtcbiAgICAgICAgZGVwZW5kZW50Vmlld3MucHVzaChkYlZpZXdOYW1lKTtcbiAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbZGJWaWV3TmFtZV0ua2V5WzBdKVxuICAgICAgICAgICAgICAgICAgJiYgbm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1tkYlZpZXdOYW1lXS5rZXlbMF0uaW5jbHVkZXMoZmllbGROYW1lKSkge1xuICAgICAgICBkZXBlbmRlbnRWaWV3cy5wdXNoKGRiVmlld05hbWUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGRlcGVuZGVudFZpZXdzLmZvckVhY2goKHZpZXdOYW1lKSA9PiB7XG4gICAgICBub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW3ZpZXdOYW1lXSA9IHt9O1xuICAgIH0pO1xuICB9LFxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBub3JtYWxpemVyO1xuIl19