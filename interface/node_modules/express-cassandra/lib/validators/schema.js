'use strict';

var _ = require('lodash');
var util = require('util');

var datatypes = require('./datatypes');

var schemer = {
  validate_table_name(tableName) {
    return typeof tableName === 'string' && /^[a-zA-Z]+[a-zA-Z0-9_]*/.test(tableName);
  },
  validate_field(modelSchema, fieldObject, fieldName) {
    if (!fieldObject) {
      throw new Error(util.format('Schema field "%s" is not properly defined', fieldName));
    }
    var fieldtype = this.get_field_type(modelSchema, fieldName);
    if (!_.has(datatypes, fieldtype)) {
      throw new Error(util.format('Invalid field type "%s" for field: %s', fieldObject.type, fieldName));
    }
    if (['map', 'list', 'set', 'frozen'].includes(fieldObject.type)) {
      if (!fieldObject.typeDef) {
        throw new Error(util.format('Missing typeDef for field type "%s" on field: %s', fieldObject.type, fieldName));
      }
      if (typeof fieldObject.typeDef !== 'string') {
        throw new Error(util.format('Invalid typeDef for field type "%s" on field: %s', fieldObject.type, fieldName));
      }
    }
    if (!this.is_field_default_value_valid(modelSchema, fieldName)) {
      throw new Error(util.format('Invalid defult value for field: %s(%s)', fieldName, fieldObject.type));
    }
  },

  validate_primary_key(modelSchema) {
    if (typeof modelSchema.key[0] === 'string') {
      if (!_.has(modelSchema.fields, modelSchema.key[0])) {
        throw new Error('Partition Key must also be a valid field name');
      }
      if (modelSchema.fields[modelSchema.key[0]].virtual) {
        throw new Error("Partition Key must also be a db field name, can't be a virtual field name");
      }
    } else if (_.isArray(modelSchema.key[0])) {
      if (modelSchema.key[0].length === 0) {
        throw new Error("Partition Key array can't be empty");
      }
      modelSchema.key[0].forEach(function (partitionKeyField) {
        if (typeof partitionKeyField !== 'string' || !_.has(modelSchema.fields, partitionKeyField)) {
          throw new Error('Partition Key array must contain only valid field names');
        }
        if (modelSchema.fields[partitionKeyField].virtual) {
          throw new Error("Partition Key array must contain only db field names, can't contain virtual field names");
        }
      });
    } else {
      throw new Error('Partition Key must be a field name string, or array of field names');
    }

    modelSchema.key.forEach(function (primaryKeyField, primaryKeyIndex) {
      if (primaryKeyIndex > 0) {
        if (typeof primaryKeyField !== 'string' || !_.has(modelSchema.fields, primaryKeyField)) {
          throw new Error('Clustering Keys must be valid field names');
        }
        if (modelSchema.fields[primaryKeyField].virtual) {
          throw new Error("Clustering Keys must be db field names, can't be virtual field names");
        }
      }
    });

    if (modelSchema.clustering_order) {
      if (!_.isPlainObject(modelSchema.clustering_order)) {
        throw new Error('clustering_order must be an object of clustering_key attributes');
      }

      _.forEach(modelSchema.clustering_order, function (clusteringOrder, clusteringFieldName) {
        if (!['asc', 'desc'].includes(clusteringOrder.toLowerCase())) {
          throw new Error('clustering_order attribute values can only be ASC or DESC');
        }
        if (modelSchema.key.indexOf(clusteringFieldName) < 1) {
          throw new Error('clustering_order field attributes must be clustering keys only');
        }
      });
    }
  },

  validate_materialized_view(modelSchema, materializedViewObject, materializedViewName) {
    if (!_.isPlainObject(materializedViewObject)) {
      throw new Error(util.format('attribute "%s" under materialized_views must be an object', materializedViewName));
    }

    if (!materializedViewObject.select || !materializedViewObject.key) {
      throw new Error(util.format('materialized_view "%s" must have "select" and "key" attributes', materializedViewName));
    }

    if (!_.isArray(materializedViewObject.select) || !_.isArray(materializedViewObject.key)) {
      throw new Error(util.format('"select" and "key" attributes must be an array under attribute %s of materialized_views', materializedViewName));
    }

    materializedViewObject.select.forEach(function (materializedViewSelectField) {
      if (typeof materializedViewSelectField !== 'string' || !(_.has(modelSchema.fields, materializedViewSelectField) || materializedViewSelectField === '*')) {
        throw new Error(util.format('the select attribute under materialized_view %s must be an array of field name strings or ["*"]', materializedViewName));
      }

      if (modelSchema.fields[materializedViewSelectField] && modelSchema.fields[materializedViewSelectField].virtual) {
        throw new Error(util.format('the select attribute under %s of materialized_views must be an array of db field names, ' + 'cannot contain any virtual field name', materializedViewName));
      }
    });

    // validate materialized_view primary key
    if (typeof materializedViewObject.key[0] === 'string') {
      if (!_.has(modelSchema.fields, materializedViewObject.key[0])) {
        throw new Error(util.format('materialized_view %s: partition key string must match a valid field name', materializedViewName));
      }
      if (modelSchema.fields[materializedViewObject.key[0]].virtual) {
        throw new Error(util.format('materialized_view %s: partition key must match a db field name, cannot be a virtual field name', materializedViewName));
      }
    } else if (_.isArray(materializedViewObject.key[0])) {
      if (materializedViewObject.key[0].length === 0) {
        throw new Error(util.format('materialized_view %s: partition key array cannot be empty', materializedViewName));
      }
      materializedViewObject.key[0].forEach(function (materializedViewPartitionKeyField) {
        if (typeof materializedViewPartitionKeyField !== 'string' || !_.has(modelSchema.fields, materializedViewPartitionKeyField)) {
          throw new Error(util.format('materialized_view %s: partition key array must contain only valid field names', materializedViewName));
        }
        if (modelSchema.fields[materializedViewPartitionKeyField].virtual) {
          throw new Error(util.format('materialized_view %s: partition key array must contain only db field names, ' + 'cannot contain virtual field names', materializedViewName));
        }
      });
    } else {
      throw new Error(util.format('materialized_view %s: partition key must be a field name string, or array of field names', materializedViewName));
    }

    materializedViewObject.key.forEach(function (materializedViewPrimaryKeyField, materializedViewPrimaryKeyIndex) {
      if (materializedViewPrimaryKeyIndex > 0) {
        if (typeof materializedViewPrimaryKeyField !== 'string' || !_.has(modelSchema.fields, materializedViewPrimaryKeyField)) {
          throw new Error(util.format('materialized_view %s: clustering keys must be valid field names', materializedViewName));
        }
        if (modelSchema.fields[materializedViewPrimaryKeyField].virtual) {
          throw new Error(util.format('materialized_view %s: clustering keys must be db field names, cannot contain virtual fields', materializedViewName));
        }
      }
    });

    if (materializedViewObject.clustering_order) {
      if (!_.isPlainObject(materializedViewObject.clustering_order)) {
        throw new Error(util.format('materialized_view %s: clustering_order must be an object of clustering_key attributes', materializedViewName));
      }

      _.forEach(materializedViewObject.clustering_order, function (mvClusteringOrder, mvlusteringFieldName) {
        if (!['asc', 'desc'].includes(mvClusteringOrder.toLowerCase())) {
          throw new Error(util.format('materialized_view %s: clustering_order attribute values can only be ASC or DESC', materializedViewName));
        }
        if (materializedViewObject.key.indexOf(mvlusteringFieldName) < 1) {
          throw new Error(util.format('materialized_view %s: clustering_order field attributes must be clustering keys only', materializedViewName));
        }
      });
    }
  },

  validate_index(modelSchema, indexDef) {
    if (typeof indexDef !== 'string') {
      throw new Error('indexes must be an array of strings');
    }

    var indexNameList = indexDef.replace(/["\s]/g, '').split(/[()]/g);
    if (indexNameList.length > 1) {
      indexNameList[0] = indexNameList[0].toLowerCase();
      if (!['entries', 'keys', 'values', 'full'].includes(indexNameList[0])) {
        throw new Error(util.format('index "%s" is not defined properly', indexDef));
      }
      if (!_.has(modelSchema.fields, indexNameList[1])) {
        throw new Error(util.format('"%s" is not a valid field name, indexes must be defined on field names', indexNameList[1]));
      }
      if (modelSchema.fields[indexNameList[1]].virtual) {
        throw new Error("indexes must be an array of db field names, can't contain virtual fields");
      }
    } else {
      if (!_.has(modelSchema.fields, indexNameList[0])) {
        throw new Error(util.format('"%s" is not a valid field, indexes must be defined on field names', indexNameList[0]));
      }
      if (modelSchema.fields[indexNameList[0]].virtual) {
        throw new Error("indexes must be an array of db field names, can't contain virtual fields");
      }
    }
  },

  validate_custom_index(modelSchema, customIndex) {
    if (!_.isPlainObject(customIndex)) {
      throw new Error('custom_index must be an object with proper indexing attributes');
    }
    if (typeof customIndex.on !== 'string' || !_.has(modelSchema.fields, customIndex.on)) {
      throw new Error("custom_index must have an 'on' attribute with string value and value must be a valid field name");
    }
    if (modelSchema.fields[customIndex.on].virtual) {
      throw new Error("custom_index 'on' attribute must be a db field name, can't contain virtual fields");
    }
    if (typeof customIndex.using !== 'string') {
      throw new Error("custom_index must have a 'using' attribute with string value");
    }
    if (!_.isPlainObject(customIndex.options)) {
      throw new Error('custom_index must have an "options" attribute and it must be an object, ' + 'pass blank {} object if no options are required');
    }
  },

  validate_model_schema(modelSchema) {
    var _this = this;

    if (!modelSchema) {
      throw new Error('A schema must be specified');
    }

    if (!_.isPlainObject(modelSchema.fields) || Object.keys(modelSchema.fields).length === 0) {
      throw new Error('Schema must contain a non-empty "fields" map object');
    }

    if (!modelSchema.key || !_.isArray(modelSchema.key)) {
      throw new Error('Schema must contain "key" in the form: [ [partitionkey1, ...], clusteringkey1, ...]');
    }

    _.forEach(modelSchema.fields, function (fieldObject, fieldName) {
      _this.validate_field(modelSchema, fieldObject, fieldName);
    });

    this.validate_primary_key(modelSchema);

    if (modelSchema.materialized_views) {
      if (!_.isPlainObject(modelSchema.materialized_views)) {
        throw new Error('materialized_views must be an object with view names as attributes');
      }
      _.forEach(modelSchema.materialized_views, function (materializedViewObject, materializedViewName) {
        _this.validate_materialized_view(modelSchema, materializedViewObject, materializedViewName);
      });
    }

    if (modelSchema.indexes) {
      if (!_.isArray(modelSchema.indexes)) {
        throw new Error('indexes must be an array of field name strings');
      }

      modelSchema.indexes.forEach(function (indexDef) {
        _this.validate_index(modelSchema, indexDef);
      });
    }

    if (modelSchema.custom_index && modelSchema.custom_indexes) {
      throw new Error('both custom_index and custom_indexes are defined in schema, only one of them should be defined');
    }

    if (modelSchema.custom_index) {
      this.validate_custom_index(modelSchema, modelSchema.custom_index);
    }

    if (modelSchema.custom_indexes) {
      if (!_.isArray(modelSchema.custom_indexes)) {
        throw new Error('custom_indexes must be an array with objects with proper indexing attributes');
      }
      modelSchema.custom_indexes.forEach(function (customIndex) {
        _this.validate_custom_index(modelSchema, customIndex);
      });
    }
  },

  format_validation_rule(rule, fieldname) {
    if (!_.isPlainObject(rule)) {
      throw new Error(util.format('Validation rule for "%s" must be a function or an object', fieldname));
    }
    if (typeof rule.validator !== 'function') {
      throw new Error(util.format('Rule validator for "%s" must be a valid function', fieldname));
    }
    if (!rule.message) {
      rule.message = this.get_generic_validation_message;
    }
    if (typeof rule.message === 'string') {
      rule.message = function f1(message) {
        return util.format(message);
      }.bind(null, rule.message);
    }
    if (typeof rule.message !== 'function') {
      throw new Error(util.format('Invalid validator message for "%s", must be string or a function', fieldname));
    }
    return rule;
  },

  get_generic_validation_message(value, propName, fieldtype) {
    return util.format('Invalid Value: "%s" for Field: %s (Type: %s)', value, propName, fieldtype);
  },

  get_validation_message(validators, value) {
    if (value == null || _.isPlainObject(value) && value.$db_function) {
      return true;
    }

    for (var v = 0; v < validators.length; v++) {
      if (typeof validators[v].validator === 'function') {
        if (!validators[v].validator(value)) {
          return validators[v].message;
        }
      }
    }
    return true;
  },

  get_validators(modelSchema, fieldname) {
    var _this2 = this;

    var validators = [];
    var fieldtype = this.get_field_type(modelSchema, fieldname);
    var typeFieldValidator = datatypes.generic_type_validator(fieldtype);

    if (typeFieldValidator) {
      validators.push(typeFieldValidator);
    }

    var field = modelSchema.fields[fieldname];
    if (typeof field.rule !== 'undefined') {
      if (typeof field.rule === 'function') {
        field.rule = {
          validator: field.rule,
          message: this.get_generic_validation_message
        };
        validators.push(field.rule);
      } else if (Array.isArray(field.rule.validators)) {
        field.rule.validators.forEach(function (fieldrule) {
          validators.push(_this2.format_validation_rule(fieldrule, fieldname));
        });
      } else if (field.rule.validator) {
        validators.push(this.format_validation_rule(field.rule, fieldname));
      }
    }

    return validators;
  },

  get_field_type(modelSchema, fieldName) {
    var fieldObject = modelSchema.fields[fieldName];

    if (typeof fieldObject === 'string') {
      return fieldObject;
    }
    if (_.isPlainObject(fieldObject)) {
      return fieldObject.type;
    }
    throw new Error('Field type not defined properly');
  },

  is_required_field(modelSchema, fieldName) {
    if (modelSchema.fields[fieldName].rule && modelSchema.fields[fieldName].rule.required) {
      return true;
    }
    return false;
  },

  is_primary_key_field(modelSchema, fieldName) {
    if (modelSchema.key.includes(fieldName) || modelSchema.key[0].includes(fieldName)) {
      return true;
    }
    return false;
  },

  is_field_default_value_valid(modelSchema, fieldName) {
    if (_.isPlainObject(modelSchema.fields[fieldName]) && modelSchema.fields[fieldName].default) {
      if (_.isPlainObject(modelSchema.fields[fieldName].default) && !modelSchema.fields[fieldName].default.$db_function) {
        return ['map', 'list', 'set', 'frozen'].includes(modelSchema.fields[fieldName].type);
      }
      return true;
    }
    return true;
  }

};

module.exports = schemer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92YWxpZGF0b3JzL3NjaGVtYS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsInV0aWwiLCJkYXRhdHlwZXMiLCJzY2hlbWVyIiwidmFsaWRhdGVfdGFibGVfbmFtZSIsInRhYmxlTmFtZSIsInRlc3QiLCJ2YWxpZGF0ZV9maWVsZCIsIm1vZGVsU2NoZW1hIiwiZmllbGRPYmplY3QiLCJmaWVsZE5hbWUiLCJFcnJvciIsImZvcm1hdCIsImZpZWxkdHlwZSIsImdldF9maWVsZF90eXBlIiwiaGFzIiwidHlwZSIsImluY2x1ZGVzIiwidHlwZURlZiIsImlzX2ZpZWxkX2RlZmF1bHRfdmFsdWVfdmFsaWQiLCJ2YWxpZGF0ZV9wcmltYXJ5X2tleSIsImtleSIsImZpZWxkcyIsInZpcnR1YWwiLCJpc0FycmF5IiwibGVuZ3RoIiwiZm9yRWFjaCIsInBhcnRpdGlvbktleUZpZWxkIiwicHJpbWFyeUtleUZpZWxkIiwicHJpbWFyeUtleUluZGV4IiwiY2x1c3RlcmluZ19vcmRlciIsImlzUGxhaW5PYmplY3QiLCJjbHVzdGVyaW5nT3JkZXIiLCJjbHVzdGVyaW5nRmllbGROYW1lIiwidG9Mb3dlckNhc2UiLCJpbmRleE9mIiwidmFsaWRhdGVfbWF0ZXJpYWxpemVkX3ZpZXciLCJtYXRlcmlhbGl6ZWRWaWV3T2JqZWN0IiwibWF0ZXJpYWxpemVkVmlld05hbWUiLCJzZWxlY3QiLCJtYXRlcmlhbGl6ZWRWaWV3U2VsZWN0RmllbGQiLCJtYXRlcmlhbGl6ZWRWaWV3UGFydGl0aW9uS2V5RmllbGQiLCJtYXRlcmlhbGl6ZWRWaWV3UHJpbWFyeUtleUZpZWxkIiwibWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlJbmRleCIsIm12Q2x1c3RlcmluZ09yZGVyIiwibXZsdXN0ZXJpbmdGaWVsZE5hbWUiLCJ2YWxpZGF0ZV9pbmRleCIsImluZGV4RGVmIiwiaW5kZXhOYW1lTGlzdCIsInJlcGxhY2UiLCJzcGxpdCIsInZhbGlkYXRlX2N1c3RvbV9pbmRleCIsImN1c3RvbUluZGV4Iiwib24iLCJ1c2luZyIsIm9wdGlvbnMiLCJ2YWxpZGF0ZV9tb2RlbF9zY2hlbWEiLCJPYmplY3QiLCJrZXlzIiwibWF0ZXJpYWxpemVkX3ZpZXdzIiwiaW5kZXhlcyIsImN1c3RvbV9pbmRleCIsImN1c3RvbV9pbmRleGVzIiwiZm9ybWF0X3ZhbGlkYXRpb25fcnVsZSIsInJ1bGUiLCJmaWVsZG5hbWUiLCJ2YWxpZGF0b3IiLCJtZXNzYWdlIiwiZ2V0X2dlbmVyaWNfdmFsaWRhdGlvbl9tZXNzYWdlIiwiZjEiLCJiaW5kIiwidmFsdWUiLCJwcm9wTmFtZSIsImdldF92YWxpZGF0aW9uX21lc3NhZ2UiLCJ2YWxpZGF0b3JzIiwiJGRiX2Z1bmN0aW9uIiwidiIsImdldF92YWxpZGF0b3JzIiwidHlwZUZpZWxkVmFsaWRhdG9yIiwiZ2VuZXJpY190eXBlX3ZhbGlkYXRvciIsInB1c2giLCJmaWVsZCIsIkFycmF5IiwiZmllbGRydWxlIiwiaXNfcmVxdWlyZWRfZmllbGQiLCJyZXF1aXJlZCIsImlzX3ByaW1hcnlfa2V5X2ZpZWxkIiwiZGVmYXVsdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsSUFBSUMsUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNQyxPQUFPRCxRQUFRLE1BQVIsQ0FBYjs7QUFFQSxJQUFNRSxZQUFZRixRQUFRLGFBQVIsQ0FBbEI7O0FBRUEsSUFBTUcsVUFBVTtBQUNkQyxzQkFBb0JDLFNBQXBCLEVBQStCO0FBQzdCLFdBQVEsT0FBT0EsU0FBUCxLQUFxQixRQUFyQixJQUFpQywwQkFBMEJDLElBQTFCLENBQStCRCxTQUEvQixDQUF6QztBQUNELEdBSGE7QUFJZEUsaUJBQWVDLFdBQWYsRUFBNEJDLFdBQTVCLEVBQXlDQyxTQUF6QyxFQUFvRDtBQUNsRCxRQUFJLENBQUNELFdBQUwsRUFBa0I7QUFDaEIsWUFBTyxJQUFJRSxLQUFKLENBQVVWLEtBQUtXLE1BQUwsQ0FBWSwyQ0FBWixFQUF5REYsU0FBekQsQ0FBVixDQUFQO0FB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QVlhLEdBQVosQ0FBZ0JKLFFBQWhCLENBQXlCUCxTQUF6QixLQUF1Q0YsWUFBWWEsR0FBWixDQUFnQixDQUFoQixFQUFtQkosUUFBbkIsQ0FBNEJQLFNBQTVCLENBQTNDLEVBQW1GO0FBQ2pGLGFBQU8sSUFBUDtBQUNEO0FBQ0QsV0FBTyxLQUFQO0FBQ0QsR0EzWGE7O0FBNlhkUywrQkFBNkJYLFdBQTdCLEVBQTBDRSxTQUExQyxFQUFxRDtBQUNuRCxRQUFJWCxFQUFFZ0MsYUFBRixDQUFnQnZCLFlBQVljLE1BQVosQ0FBbUJaLFNBQW5CLENBQWhCLEtBQWtERixZQUFZYyxNQUFaLENBQW1CWixTQUFuQixFQUE4QjZFLE9BQXBGLEVBQTZGO0FBQzNGLFVBQUl4RixFQUFFZ0MsYUFBRixDQUFnQnZCLFlBQVljLE1BQVosQ0FBbUJaLFNBQW5CLEVBQThCNkUsT0FBOUMsS0FDRyxDQUFFL0UsWUFBWWMsTUFBWixDQUFtQlosU0FBbkIsRUFBOEI2RSxPQUE5QixDQUFzQ1osWUFEL0MsRUFDOEQ7QUFDNUQsZUFBTyxDQUFDLEtBQUQsRUFBUSxNQUFSLEVBQWdCLEtBQWhCLEVBQXVCLFFBQXZCLEVBQWlDMUQsUUFBakMsQ0FBMENULFlBQVljLE1BQVosQ0FBbUJaLFNBQW5CLEVBQThCTSxJQUF4RSxDQUFQO0FBQ0Q7QUFDRCxhQUFPLElBQVA7QUFDRDtBQUNELFdBQU8sSUFBUDtBQUNEOztBQXRZYSxDQUFoQjs7QUEwWUF3RSxPQUFPQyxPQUFQLEdBQWlCdEYsT0FBakIiLCJmaWxlIjoic2NoZW1hLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcblxuY29uc3QgZGF0YXR5cGVzID0gcmVxdWlyZSgnLi9kYXRhdHlwZXMnKTtcblxuY29uc3Qgc2NoZW1lciA9IHtcbiAgdmFsaWRhdGVfdGFibGVfbmFtZSh0YWJsZU5hbWUpIHtcbiAgICByZXR1cm4gKHR5cGVvZiB0YWJsZU5hbWUgPT09ICdzdHJpbmcnICYmIC9eW2EtekEtWl0rW2EtekEtWjAtOV9dKi8udGVzdCh0YWJsZU5hbWUpKTtcbiAgfSxcbiAgdmFsaWRhdGVfZmllbGQobW9kZWxTY2hlbWEsIGZpZWxkT2JqZWN0LCBmaWVsZE5hbWUpIHtcbiAgICBpZiAoIWZpZWxkT2JqZWN0KSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdTY2hlbWEgZmllbGQgXCIlc1wiIGlzIG5vdCBwcm9wZXJseSBkZWZpbmVkJywgZmllbGROYW1lKSkpO1xuICAgIH1cbiAgICBjb25zdCBmaWVsZHR5cGUgPSB0aGlzLmdldF9maWVsZF90eXBlKG1vZGVsU2NoZW1hLCBmaWVsZE5hbWUpO1xuICAgIGlmICghXy5oYXMoZGF0YXR5cGVzLCBmaWVsZHR5cGUpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdJbnZhbGlkIGZpZWxkIHR5cGUgXCIlc1wiIGZvciBmaWVsZDogJXMnLCBmaWVsZE9iamVjdC50eXBlLCBmaWVsZE5hbWUpKSk7XG4gICAgfVxuICAgIGlmIChbJ21hcCcsICdsaXN0JywgJ3NldCcsICdmcm96ZW4nXS5pbmNsdWRlcyhmaWVsZE9iamVjdC50eXBlKSkge1xuICAgICAgaWYgKCFmaWVsZE9iamVjdC50eXBlRGVmKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ01pc3NpbmcgdHlwZURlZiBmb3IgZmllbGQgdHlwZSBcIiVzXCIgb24gZmllbGQ6ICVzJywgZmllbGRPYmplY3QudHlwZSwgZmllbGROYW1lKSkpO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBmaWVsZE9iamVjdC50eXBlRGVmICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdJbnZhbGlkIHR5cGVEZWYgZm9yIGZpZWxkIHR5cGUgXCIlc1wiIG9uIGZpZWxkOiAlcycsIGZpZWxkT2JqZWN0LnR5cGUsIGZpZWxkTmFtZSkpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKCEodGhpcy5pc19maWVsZF9kZWZhdWx0X3ZhbHVlX3ZhbGlkKG1vZGVsU2NoZW1hLCBmaWVsZE5hbWUpKSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdCgnSW52YWxpZCBkZWZ1bHQgdmFsdWUgZm9yIGZpZWxkOiAlcyglcyknLCBmaWVsZE5hbWUsIGZpZWxkT2JqZWN0LnR5cGUpKSk7XG4gICAgfVxuICB9LFxuXG4gIHZhbGlkYXRlX3ByaW1hcnlfa2V5KG1vZGVsU2NoZW1hKSB7XG4gICAgaWYgKHR5cGVvZiAobW9kZWxTY2hlbWEua2V5WzBdKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlmICghXy5oYXMobW9kZWxTY2hlbWEuZmllbGRzLCBtb2RlbFNjaGVtYS5rZXlbMF0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoJ1BhcnRpdGlvbiBLZXkgbXVzdCBhbHNvIGJlIGEgdmFsaWQgZmllbGQgbmFtZScpKTtcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEua2V5WzBdXS52aXJ0dWFsKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXCJQYXJ0aXRpb24gS2V5IG11c3QgYWxzbyBiZSBhIGRiIGZpZWxkIG5hbWUsIGNhbid0IGJlIGEgdmlydHVhbCBmaWVsZCBuYW1lXCIpKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShtb2RlbFNjaGVtYS5rZXlbMF0pKSB7XG4gICAgICBpZiAobW9kZWxTY2hlbWEua2V5WzBdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiUGFydGl0aW9uIEtleSBhcnJheSBjYW4ndCBiZSBlbXB0eVwiKSk7XG4gICAgICB9XG4gICAgICBtb2RlbFNjaGVtYS5rZXlbMF0uZm9yRWFjaCgocGFydGl0aW9uS2V5RmllbGQpID0+IHtcbiAgICAgICAgaWYgKCh0eXBlb2YgKHBhcnRpdGlvbktleUZpZWxkKSAhPT0gJ3N0cmluZycpIHx8ICFfLmhhcyhtb2RlbFNjaGVtYS5maWVsZHMsIHBhcnRpdGlvbktleUZpZWxkKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoJ1BhcnRpdGlvbiBLZXkgYXJyYXkgbXVzdCBjb250YWluIG9ubHkgdmFsaWQgZmllbGQgbmFtZXMnKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1twYXJ0aXRpb25LZXlGaWVsZF0udmlydHVhbCkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXCJQYXJ0aXRpb24gS2V5IGFycmF5IG11c3QgY29udGFpbiBvbmx5IGRiIGZpZWxkIG5hbWVzLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGQgbmFtZXNcIikpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignUGFydGl0aW9uIEtleSBtdXN0IGJlIGEgZmllbGQgbmFtZSBzdHJpbmcsIG9yIGFycmF5IG9mIGZpZWxkIG5hbWVzJykpO1xuICAgIH1cblxuICAgIG1vZGVsU2NoZW1hLmtleS5mb3JFYWNoKChwcmltYXJ5S2V5RmllbGQsIHByaW1hcnlLZXlJbmRleCkgPT4ge1xuICAgICAgaWYgKHByaW1hcnlLZXlJbmRleCA+IDApIHtcbiAgICAgICAgaWYgKCh0eXBlb2YgKHByaW1hcnlLZXlGaWVsZCkgIT09ICdzdHJpbmcnKSB8fCAhXy5oYXMobW9kZWxTY2hlbWEuZmllbGRzLCBwcmltYXJ5S2V5RmllbGQpKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignQ2x1c3RlcmluZyBLZXlzIG11c3QgYmUgdmFsaWQgZmllbGQgbmFtZXMnKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1twcmltYXJ5S2V5RmllbGRdLnZpcnR1YWwpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiQ2x1c3RlcmluZyBLZXlzIG11c3QgYmUgZGIgZmllbGQgbmFtZXMsIGNhbid0IGJlIHZpcnR1YWwgZmllbGQgbmFtZXNcIikpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikge1xuICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignY2x1c3RlcmluZ19vcmRlciBtdXN0IGJlIGFuIG9iamVjdCBvZiBjbHVzdGVyaW5nX2tleSBhdHRyaWJ1dGVzJykpO1xuICAgICAgfVxuXG4gICAgICBfLmZvckVhY2gobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlciwgKGNsdXN0ZXJpbmdPcmRlciwgY2x1c3RlcmluZ0ZpZWxkTmFtZSkgPT4ge1xuICAgICAgICBpZiAoIVsnYXNjJywgJ2Rlc2MnXS5pbmNsdWRlcyhjbHVzdGVyaW5nT3JkZXIudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKCdjbHVzdGVyaW5nX29yZGVyIGF0dHJpYnV0ZSB2YWx1ZXMgY2FuIG9ubHkgYmUgQVNDIG9yIERFU0MnKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmtleS5pbmRleE9mKGNsdXN0ZXJpbmdGaWVsZE5hbWUpIDwgMSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoJ2NsdXN0ZXJpbmdfb3JkZXIgZmllbGQgYXR0cmlidXRlcyBtdXN0IGJlIGNsdXN0ZXJpbmcga2V5cyBvbmx5JykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfbWF0ZXJpYWxpemVkX3ZpZXcobW9kZWxTY2hlbWEsIG1hdGVyaWFsaXplZFZpZXdPYmplY3QsIG1hdGVyaWFsaXplZFZpZXdOYW1lKSB7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobWF0ZXJpYWxpemVkVmlld09iamVjdCkpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ2F0dHJpYnV0ZSBcIiVzXCIgdW5kZXIgbWF0ZXJpYWxpemVkX3ZpZXdzIG11c3QgYmUgYW4gb2JqZWN0JywgbWF0ZXJpYWxpemVkVmlld05hbWUpKSk7XG4gICAgfVxuXG4gICAgaWYgKCFtYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LnNlbGVjdCB8fCAhbWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3IFwiJXNcIiBtdXN0IGhhdmUgXCJzZWxlY3RcIiBhbmQgXCJrZXlcIiBhdHRyaWJ1dGVzJywgbWF0ZXJpYWxpemVkVmlld05hbWUpKSk7XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzQXJyYXkobWF0ZXJpYWxpemVkVmlld09iamVjdC5zZWxlY3QpIHx8ICFfLmlzQXJyYXkobWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdcInNlbGVjdFwiIGFuZCBcImtleVwiIGF0dHJpYnV0ZXMgbXVzdCBiZSBhbiBhcnJheSB1bmRlciBhdHRyaWJ1dGUgJXMgb2YgbWF0ZXJpYWxpemVkX3ZpZXdzJywgbWF0ZXJpYWxpemVkVmlld05hbWUpKSk7XG4gICAgfVxuXG4gICAgbWF0ZXJpYWxpemVkVmlld09iamVjdC5zZWxlY3QuZm9yRWFjaCgobWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkKSA9PiB7XG4gICAgICBpZiAoKHR5cGVvZiAobWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkKSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICB8fCAhKF8uaGFzKG1vZGVsU2NoZW1hLmZpZWxkcywgbWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkKVxuICAgICAgICAgICAgfHwgbWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkID09PSAnKicpKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoXG4gICAgICAgICAgJ3RoZSBzZWxlY3QgYXR0cmlidXRlIHVuZGVyIG1hdGVyaWFsaXplZF92aWV3ICVzIG11c3QgYmUgYW4gYXJyYXkgb2YgZmllbGQgbmFtZSBzdHJpbmdzIG9yIFtcIipcIl0nLFxuICAgICAgICAgIG1hdGVyaWFsaXplZFZpZXdOYW1lLFxuICAgICAgICApKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbWF0ZXJpYWxpemVkVmlld1NlbGVjdEZpZWxkXVxuICAgICAgICAgICYmIG1vZGVsU2NoZW1hLmZpZWxkc1ttYXRlcmlhbGl6ZWRWaWV3U2VsZWN0RmllbGRdLnZpcnR1YWwpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAndGhlIHNlbGVjdCBhdHRyaWJ1dGUgdW5kZXIgJXMgb2YgbWF0ZXJpYWxpemVkX3ZpZXdzIG11c3QgYmUgYW4gYXJyYXkgb2YgZGIgZmllbGQgbmFtZXMsICcgK1xuICAgICAgICAgICdjYW5ub3QgY29udGFpbiBhbnkgdmlydHVhbCBmaWVsZCBuYW1lJyxcbiAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgKSkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gdmFsaWRhdGUgbWF0ZXJpYWxpemVkX3ZpZXcgcHJpbWFyeSBrZXlcbiAgICBpZiAodHlwZW9mIChtYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LmtleVswXSkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAoIV8uaGFzKG1vZGVsU2NoZW1hLmZpZWxkcywgbWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXlbMF0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBwYXJ0aXRpb24ga2V5IHN0cmluZyBtdXN0IG1hdGNoIGEgdmFsaWQgZmllbGQgbmFtZScsIG1hdGVyaWFsaXplZFZpZXdOYW1lKSkpO1xuICAgICAgfVxuICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1ttYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LmtleVswXV0udmlydHVhbCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KFxuICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBtdXN0IG1hdGNoIGEgZGIgZmllbGQgbmFtZSwgY2Fubm90IGJlIGEgdmlydHVhbCBmaWVsZCBuYW1lJyxcbiAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgKSkpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdKSkge1xuICAgICAgaWYgKG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBhcnJheSBjYW5ub3QgYmUgZW1wdHknLCBtYXRlcmlhbGl6ZWRWaWV3TmFtZSkpKTtcbiAgICAgIH1cbiAgICAgIG1hdGVyaWFsaXplZFZpZXdPYmplY3Qua2V5WzBdLmZvckVhY2goKG1hdGVyaWFsaXplZFZpZXdQYXJ0aXRpb25LZXlGaWVsZCkgPT4ge1xuICAgICAgICBpZiAoKHR5cGVvZiAobWF0ZXJpYWxpemVkVmlld1BhcnRpdGlvbktleUZpZWxkKSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICB8fCAhXy5oYXMobW9kZWxTY2hlbWEuZmllbGRzLCBtYXRlcmlhbGl6ZWRWaWV3UGFydGl0aW9uS2V5RmllbGQpKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBhcnJheSBtdXN0IGNvbnRhaW4gb25seSB2YWxpZCBmaWVsZCBuYW1lcycsXG4gICAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgICApKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1ttYXRlcmlhbGl6ZWRWaWV3UGFydGl0aW9uS2V5RmllbGRdLnZpcnR1YWwpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgJ21hdGVyaWFsaXplZF92aWV3ICVzOiBwYXJ0aXRpb24ga2V5IGFycmF5IG11c3QgY29udGFpbiBvbmx5IGRiIGZpZWxkIG5hbWVzLCAnICtcbiAgICAgICAgICAgICdjYW5ub3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkIG5hbWVzJyxcbiAgICAgICAgICAgIG1hdGVyaWFsaXplZFZpZXdOYW1lLFxuICAgICAgICAgICkpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoXG4gICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBtdXN0IGJlIGEgZmllbGQgbmFtZSBzdHJpbmcsIG9yIGFycmF5IG9mIGZpZWxkIG5hbWVzJyxcbiAgICAgICAgbWF0ZXJpYWxpemVkVmlld05hbWUsXG4gICAgICApKSk7XG4gICAgfVxuXG4gICAgbWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkuZm9yRWFjaCgobWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlGaWVsZCwgbWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlJbmRleCkgPT4ge1xuICAgICAgaWYgKG1hdGVyaWFsaXplZFZpZXdQcmltYXJ5S2V5SW5kZXggPiAwKSB7XG4gICAgICAgIGlmICgodHlwZW9mIChtYXRlcmlhbGl6ZWRWaWV3UHJpbWFyeUtleUZpZWxkKSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICB8fCAhXy5oYXMobW9kZWxTY2hlbWEuZmllbGRzLCBtYXRlcmlhbGl6ZWRWaWV3UHJpbWFyeUtleUZpZWxkKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBjbHVzdGVyaW5nIGtleXMgbXVzdCBiZSB2YWxpZCBmaWVsZCBuYW1lcycsIG1hdGVyaWFsaXplZFZpZXdOYW1lKSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbWF0ZXJpYWxpemVkVmlld1ByaW1hcnlLZXlGaWVsZF0udmlydHVhbCkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoXG4gICAgICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IGNsdXN0ZXJpbmcga2V5cyBtdXN0IGJlIGRiIGZpZWxkIG5hbWVzLCBjYW5ub3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkcycsXG4gICAgICAgICAgICBtYXRlcmlhbGl6ZWRWaWV3TmFtZSxcbiAgICAgICAgICApKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChtYXRlcmlhbGl6ZWRWaWV3T2JqZWN0LmNsdXN0ZXJpbmdfb3JkZXIpIHtcbiAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1hdGVyaWFsaXplZFZpZXdPYmplY3QuY2x1c3RlcmluZ19vcmRlcikpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IGNsdXN0ZXJpbmdfb3JkZXIgbXVzdCBiZSBhbiBvYmplY3Qgb2YgY2x1c3RlcmluZ19rZXkgYXR0cmlidXRlcycsXG4gICAgICAgICAgbWF0ZXJpYWxpemVkVmlld05hbWUsXG4gICAgICAgICkpKTtcbiAgICAgIH1cblxuICAgICAgXy5mb3JFYWNoKG1hdGVyaWFsaXplZFZpZXdPYmplY3QuY2x1c3RlcmluZ19vcmRlciwgKG12Q2x1c3RlcmluZ09yZGVyLCBtdmx1c3RlcmluZ0ZpZWxkTmFtZSkgPT4ge1xuICAgICAgICBpZiAoIVsnYXNjJywgJ2Rlc2MnXS5pbmNsdWRlcyhtdkNsdXN0ZXJpbmdPcmRlci50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBjbHVzdGVyaW5nX29yZGVyIGF0dHJpYnV0ZSB2YWx1ZXMgY2FuIG9ubHkgYmUgQVNDIG9yIERFU0MnLCBtYXRlcmlhbGl6ZWRWaWV3TmFtZSkpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWF0ZXJpYWxpemVkVmlld09iamVjdC5rZXkuaW5kZXhPZihtdmx1c3RlcmluZ0ZpZWxkTmFtZSkgPCAxKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcih1dGlsLmZvcm1hdChcbiAgICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogY2x1c3RlcmluZ19vcmRlciBmaWVsZCBhdHRyaWJ1dGVzIG11c3QgYmUgY2x1c3RlcmluZyBrZXlzIG9ubHknLFxuICAgICAgICAgICAgbWF0ZXJpYWxpemVkVmlld05hbWUsXG4gICAgICAgICAgKSkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfaW5kZXgobW9kZWxTY2hlbWEsIGluZGV4RGVmKSB7XG4gICAgaWYgKHR5cGVvZiBpbmRleERlZiAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ2luZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBzdHJpbmdzJykpO1xuICAgIH1cblxuICAgIGNvbnN0IGluZGV4TmFtZUxpc3QgPSBpbmRleERlZi5yZXBsYWNlKC9bXCJcXHNdL2csICcnKS5zcGxpdCgvWygpXS9nKTtcbiAgICBpZiAoaW5kZXhOYW1lTGlzdC5sZW5ndGggPiAxKSB7XG4gICAgICBpbmRleE5hbWVMaXN0WzBdID0gaW5kZXhOYW1lTGlzdFswXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKCFbJ2VudHJpZXMnLCAna2V5cycsICd2YWx1ZXMnLCAnZnVsbCddLmluY2x1ZGVzKGluZGV4TmFtZUxpc3RbMF0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ2luZGV4IFwiJXNcIiBpcyBub3QgZGVmaW5lZCBwcm9wZXJseScsIGluZGV4RGVmKSkpO1xuICAgICAgfVxuICAgICAgaWYgKCFfLmhhcyhtb2RlbFNjaGVtYS5maWVsZHMsIGluZGV4TmFtZUxpc3RbMV0pKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IodXRpbC5mb3JtYXQoJ1wiJXNcIiBpcyBub3QgYSB2YWxpZCBmaWVsZCBuYW1lLCBpbmRleGVzIG11c3QgYmUgZGVmaW5lZCBvbiBmaWVsZCBuYW1lcycsIGluZGV4TmFtZUxpc3RbMV0pKSk7XG4gICAgICB9XG4gICAgICBpZiAobW9kZWxTY2hlbWEuZmllbGRzW2luZGV4TmFtZUxpc3RbMV1dLnZpcnR1YWwpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihcImluZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBkYiBmaWVsZCBuYW1lcywgY2FuJ3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkc1wiKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghXy5oYXMobW9kZWxTY2hlbWEuZmllbGRzLCBpbmRleE5hbWVMaXN0WzBdKSkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdcIiVzXCIgaXMgbm90IGEgdmFsaWQgZmllbGQsIGluZGV4ZXMgbXVzdCBiZSBkZWZpbmVkIG9uIGZpZWxkIG5hbWVzJywgaW5kZXhOYW1lTGlzdFswXSkpKTtcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbaW5kZXhOYW1lTGlzdFswXV0udmlydHVhbCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiaW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IG9mIGRiIGZpZWxkIG5hbWVzLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGRzXCIpKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfY3VzdG9tX2luZGV4KG1vZGVsU2NoZW1hLCBjdXN0b21JbmRleCkge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGN1c3RvbUluZGV4KSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignY3VzdG9tX2luZGV4IG11c3QgYmUgYW4gb2JqZWN0IHdpdGggcHJvcGVyIGluZGV4aW5nIGF0dHJpYnV0ZXMnKSk7XG4gICAgfVxuICAgIGlmICgodHlwZW9mIChjdXN0b21JbmRleC5vbikgIT09ICdzdHJpbmcnKSB8fCAhXy5oYXMobW9kZWxTY2hlbWEuZmllbGRzLCBjdXN0b21JbmRleC5vbikpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoXCJjdXN0b21faW5kZXggbXVzdCBoYXZlIGFuICdvbicgYXR0cmlidXRlIHdpdGggc3RyaW5nIHZhbHVlIGFuZCB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgZmllbGQgbmFtZVwiKSk7XG4gICAgfVxuICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbY3VzdG9tSW5kZXgub25dLnZpcnR1YWwpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoXCJjdXN0b21faW5kZXggJ29uJyBhdHRyaWJ1dGUgbXVzdCBiZSBhIGRiIGZpZWxkIG5hbWUsIGNhbid0IGNvbnRhaW4gdmlydHVhbCBmaWVsZHNcIikpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIChjdXN0b21JbmRleC51c2luZykgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKFwiY3VzdG9tX2luZGV4IG11c3QgaGF2ZSBhICd1c2luZycgYXR0cmlidXRlIHdpdGggc3RyaW5nIHZhbHVlXCIpKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QoY3VzdG9tSW5kZXgub3B0aW9ucykpIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ2N1c3RvbV9pbmRleCBtdXN0IGhhdmUgYW4gXCJvcHRpb25zXCIgYXR0cmlidXRlIGFuZCBpdCBtdXN0IGJlIGFuIG9iamVjdCwgJyArXG4gICAgICAgICdwYXNzIGJsYW5rIHt9IG9iamVjdCBpZiBubyBvcHRpb25zIGFyZSByZXF1aXJlZCcpKTtcbiAgICB9XG4gIH0sXG5cbiAgdmFsaWRhdGVfbW9kZWxfc2NoZW1hKG1vZGVsU2NoZW1hKSB7XG4gICAgaWYgKCFtb2RlbFNjaGVtYSkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignQSBzY2hlbWEgbXVzdCBiZSBzcGVjaWZpZWQnKSk7XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobW9kZWxTY2hlbWEuZmllbGRzKSB8fCBPYmplY3Qua2V5cyhtb2RlbFNjaGVtYS5maWVsZHMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignU2NoZW1hIG11c3QgY29udGFpbiBhIG5vbi1lbXB0eSBcImZpZWxkc1wiIG1hcCBvYmplY3QnKSk7XG4gICAgfVxuXG4gICAgaWYgKCFtb2RlbFNjaGVtYS5rZXkgfHwgIV8uaXNBcnJheShtb2RlbFNjaGVtYS5rZXkpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKCdTY2hlbWEgbXVzdCBjb250YWluIFwia2V5XCIgaW4gdGhlIGZvcm06IFsgW3BhcnRpdGlvbmtleTEsIC4uLl0sIGNsdXN0ZXJpbmdrZXkxLCAuLi5dJykpO1xuICAgIH1cblxuICAgIF8uZm9yRWFjaChtb2RlbFNjaGVtYS5maWVsZHMsIChmaWVsZE9iamVjdCwgZmllbGROYW1lKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRlX2ZpZWxkKG1vZGVsU2NoZW1hLCBmaWVsZE9iamVjdCwgZmllbGROYW1lKTtcbiAgICB9KTtcblxuICAgIHRoaXMudmFsaWRhdGVfcHJpbWFyeV9rZXkobW9kZWxTY2hlbWEpO1xuXG4gICAgaWYgKG1vZGVsU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cykge1xuICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QobW9kZWxTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzKSkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKCdtYXRlcmlhbGl6ZWRfdmlld3MgbXVzdCBiZSBhbiBvYmplY3Qgd2l0aCB2aWV3IG5hbWVzIGFzIGF0dHJpYnV0ZXMnKSk7XG4gICAgICB9XG4gICAgICBfLmZvckVhY2gobW9kZWxTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzLCAobWF0ZXJpYWxpemVkVmlld09iamVjdCwgbWF0ZXJpYWxpemVkVmlld05hbWUpID0+IHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZV9tYXRlcmlhbGl6ZWRfdmlldyhtb2RlbFNjaGVtYSwgbWF0ZXJpYWxpemVkVmlld09iamVjdCwgbWF0ZXJpYWxpemVkVmlld05hbWUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmluZGV4ZXMpIHtcbiAgICAgIGlmICghXy5pc0FycmF5KG1vZGVsU2NoZW1hLmluZGV4ZXMpKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoJ2luZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBmaWVsZCBuYW1lIHN0cmluZ3MnKSk7XG4gICAgICB9XG5cbiAgICAgIG1vZGVsU2NoZW1hLmluZGV4ZXMuZm9yRWFjaCgoaW5kZXhEZWYpID0+IHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZV9pbmRleChtb2RlbFNjaGVtYSwgaW5kZXhEZWYpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleCAmJiBtb2RlbFNjaGVtYS5jdXN0b21faW5kZXhlcykge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcignYm90aCBjdXN0b21faW5kZXggYW5kIGN1c3RvbV9pbmRleGVzIGFyZSBkZWZpbmVkIGluIHNjaGVtYSwgb25seSBvbmUgb2YgdGhlbSBzaG91bGQgYmUgZGVmaW5lZCcpKTtcbiAgICB9XG5cbiAgICBpZiAobW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4KSB7XG4gICAgICB0aGlzLnZhbGlkYXRlX2N1c3RvbV9pbmRleChtb2RlbFNjaGVtYSwgbW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4KTtcbiAgICB9XG5cbiAgICBpZiAobW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4ZXMpIHtcbiAgICAgIGlmICghXy5pc0FycmF5KG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleGVzKSkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKCdjdXN0b21faW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IHdpdGggb2JqZWN0cyB3aXRoIHByb3BlciBpbmRleGluZyBhdHRyaWJ1dGVzJykpO1xuICAgICAgfVxuICAgICAgbW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4ZXMuZm9yRWFjaCgoY3VzdG9tSW5kZXgpID0+IHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZV9jdXN0b21faW5kZXgobW9kZWxTY2hlbWEsIGN1c3RvbUluZGV4KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcblxuICBmb3JtYXRfdmFsaWRhdGlvbl9ydWxlKHJ1bGUsIGZpZWxkbmFtZSkge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHJ1bGUpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdWYWxpZGF0aW9uIHJ1bGUgZm9yIFwiJXNcIiBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0JywgZmllbGRuYW1lKSkpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHJ1bGUudmFsaWRhdG9yICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdSdWxlIHZhbGlkYXRvciBmb3IgXCIlc1wiIG11c3QgYmUgYSB2YWxpZCBmdW5jdGlvbicsIGZpZWxkbmFtZSkpKTtcbiAgICB9XG4gICAgaWYgKCFydWxlLm1lc3NhZ2UpIHtcbiAgICAgIHJ1bGUubWVzc2FnZSA9IHRoaXMuZ2V0X2dlbmVyaWNfdmFsaWRhdGlvbl9tZXNzYWdlO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHJ1bGUubWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJ1bGUubWVzc2FnZSA9IGZ1bmN0aW9uIGYxKG1lc3NhZ2UpIHtcbiAgICAgICAgcmV0dXJuIHV0aWwuZm9ybWF0KG1lc3NhZ2UpO1xuICAgICAgfS5iaW5kKG51bGwsIHJ1bGUubWVzc2FnZSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgcnVsZS5tZXNzYWdlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdJbnZhbGlkIHZhbGlkYXRvciBtZXNzYWdlIGZvciBcIiVzXCIsIG11c3QgYmUgc3RyaW5nIG9yIGEgZnVuY3Rpb24nLCBmaWVsZG5hbWUpKSk7XG4gICAgfVxuICAgIHJldHVybiBydWxlO1xuICB9LFxuXG4gIGdldF9nZW5lcmljX3ZhbGlkYXRpb25fbWVzc2FnZSh2YWx1ZSwgcHJvcE5hbWUsIGZpZWxkdHlwZSkge1xuICAgIHJldHVybiB1dGlsLmZvcm1hdCgnSW52YWxpZCBWYWx1ZTogXCIlc1wiIGZvciBGaWVsZDogJXMgKFR5cGU6ICVzKScsIHZhbHVlLCBwcm9wTmFtZSwgZmllbGR0eXBlKTtcbiAgfSxcblxuICBnZXRfdmFsaWRhdGlvbl9tZXNzYWdlKHZhbGlkYXRvcnMsIHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlID09IG51bGwgfHwgKF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkgJiYgdmFsdWUuJGRiX2Z1bmN0aW9uKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgdiA9IDA7IHYgPCB2YWxpZGF0b3JzLmxlbmd0aDsgdisrKSB7XG4gICAgICBpZiAodHlwZW9mIHZhbGlkYXRvcnNbdl0udmFsaWRhdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGlmICghdmFsaWRhdG9yc1t2XS52YWxpZGF0b3IodmFsdWUpKSB7XG4gICAgICAgICAgcmV0dXJuIHZhbGlkYXRvcnNbdl0ubWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSxcblxuICBnZXRfdmFsaWRhdG9ycyhtb2RlbFNjaGVtYSwgZmllbGRuYW1lKSB7XG4gICAgY29uc3QgdmFsaWRhdG9ycyA9IFtdO1xuICAgIGNvbnN0IGZpZWxkdHlwZSA9IHRoaXMuZ2V0X2ZpZWxkX3R5cGUobW9kZWxTY2hlbWEsIGZpZWxkbmFtZSk7XG4gICAgY29uc3QgdHlwZUZpZWxkVmFsaWRhdG9yID0gZGF0YXR5cGVzLmdlbmVyaWNfdHlwZV92YWxpZGF0b3IoZmllbGR0eXBlKTtcblxuICAgIGlmICh0eXBlRmllbGRWYWxpZGF0b3IpIHtcbiAgICAgIHZhbGlkYXRvcnMucHVzaCh0eXBlRmllbGRWYWxpZGF0b3IpO1xuICAgIH1cblxuICAgIGNvbnN0IGZpZWxkID0gbW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkbmFtZV07XG4gICAgaWYgKHR5cGVvZiBmaWVsZC5ydWxlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgaWYgKHR5cGVvZiBmaWVsZC5ydWxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGZpZWxkLnJ1bGUgPSB7XG4gICAgICAgICAgdmFsaWRhdG9yOiBmaWVsZC5ydWxlLFxuICAgICAgICAgIG1lc3NhZ2U6IHRoaXMuZ2V0X2dlbmVyaWNfdmFsaWRhdGlvbl9tZXNzYWdlLFxuICAgICAgICB9O1xuICAgICAgICB2YWxpZGF0b3JzLnB1c2goZmllbGQucnVsZSk7XG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZmllbGQucnVsZS52YWxpZGF0b3JzKSkge1xuICAgICAgICBmaWVsZC5ydWxlLnZhbGlkYXRvcnMuZm9yRWFjaCgoZmllbGRydWxlKSA9PiB7XG4gICAgICAgICAgdmFsaWRhdG9ycy5wdXNoKHRoaXMuZm9ybWF0X3ZhbGlkYXRpb25fcnVsZShmaWVsZHJ1bGUsIGZpZWxkbmFtZSkpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoZmllbGQucnVsZS52YWxpZGF0b3IpIHtcbiAgICAgICAgdmFsaWRhdG9ycy5wdXNoKHRoaXMuZm9ybWF0X3ZhbGlkYXRpb25fcnVsZShmaWVsZC5ydWxlLCBmaWVsZG5hbWUpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdmFsaWRhdG9ycztcbiAgfSxcblxuICBnZXRfZmllbGRfdHlwZShtb2RlbFNjaGVtYSwgZmllbGROYW1lKSB7XG4gICAgY29uc3QgZmllbGRPYmplY3QgPSBtb2RlbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXTtcblxuICAgIGlmICh0eXBlb2YgZmllbGRPYmplY3QgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gZmllbGRPYmplY3Q7XG4gICAgfVxuICAgIGlmIChfLmlzUGxhaW5PYmplY3QoZmllbGRPYmplY3QpKSB7XG4gICAgICByZXR1cm4gZmllbGRPYmplY3QudHlwZTtcbiAgICB9XG4gICAgdGhyb3cgKG5ldyBFcnJvcignRmllbGQgdHlwZSBub3QgZGVmaW5lZCBwcm9wZXJseScpKTtcbiAgfSxcblxuICBpc19yZXF1aXJlZF9maWVsZChtb2RlbFNjaGVtYSwgZmllbGROYW1lKSB7XG4gICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnJ1bGUgJiYgbW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0ucnVsZS5yZXF1aXJlZCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSxcblxuICBpc19wcmltYXJ5X2tleV9maWVsZChtb2RlbFNjaGVtYSwgZmllbGROYW1lKSB7XG4gICAgaWYgKG1vZGVsU2NoZW1hLmtleS5pbmNsdWRlcyhmaWVsZE5hbWUpIHx8IG1vZGVsU2NoZW1hLmtleVswXS5pbmNsdWRlcyhmaWVsZE5hbWUpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9LFxuXG4gIGlzX2ZpZWxkX2RlZmF1bHRfdmFsdWVfdmFsaWQobW9kZWxTY2hlbWEsIGZpZWxkTmFtZSkge1xuICAgIGlmIChfLmlzUGxhaW5PYmplY3QobW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0pICYmIG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLmRlZmF1bHQpIHtcbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QobW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0uZGVmYXVsdClcbiAgICAgICAgICAmJiAhKG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLmRlZmF1bHQuJGRiX2Z1bmN0aW9uKSkge1xuICAgICAgICByZXR1cm4gWydtYXAnLCAnbGlzdCcsICdzZXQnLCAnZnJvemVuJ10uaW5jbHVkZXMobW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sXG5cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gc2NoZW1lcjtcbiJdfQ==